<!DOCTYPE html>
<html lang="{{ site.language }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  {# Precompute values to avoid parser edge cases #}
  {% set headline  = title or site.title %}
  {% set metaDesc  = description or site.description %}
  {% set canonical = page.url | url | absoluteUrl(site.url) %}
  {% set ogImage   = '/apple-touch-icon.png' | url | absoluteUrl(site.url) %}

  <title>{% if title %}{{ title }} | {% endif %}{{ site.title }}</title>
  <meta name="description" content="{{ metaDesc }}">

  {# Canonical (absolute + prefix-safe) #}
  <link rel="canonical" href="{{ canonical }}">

  {# Favicons (prefix-safe) #}
  <link rel="icon" type="image/x-icon" href="{{ '/favicon.ico' | url }}">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ '/apple-touch-icon.png' | url }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ '/favicon-32x32.png' | url }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ '/favicon-16x16.png' | url }}">
  <link rel="mask-icon" href="{{ '/safari-pinned-tab.svg' | url }}" color="#0065bd">

  {# Styles (prefix-safe) #}
  <link rel="stylesheet" href="{{ '/css/main.css' | url }}">

  {# Open Graph (absolute) #}
  <meta property="og:title" content="{{ headline }}">
  <meta property="og:description" content="{{ metaDesc }}">
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ canonical }}">
  <meta property="og:image" content="{{ ogImage }}">

  {# JSON-LD (use a string literal for stability) #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "TechArticle",
    "headline": "{{ headline | escape }}",
    "description": "{{ metaDesc | escape }}",
    "url": "{{ canonical }}",
    "image": "{{ ogImage }}",
    "author": {
      "@type": "Organization",
      "name": "{{ site.organization.name | escape }}",
      "url": "{{ site.organization.url }}"
    },
    "publisher": {
      "@type": "Organization",
      "name": "{{ site.organization.name | escape }}",
      "url": "{{ site.organization.url }}"
    }
  }
  </script>
</head>

<body>
  <!-- Cookie banner and skip link as you had, if needed -->

  <header class="sg-header" role="banner">
    <div class="sg-header__wrapper">
      <div class="sg-header__branding">
        <a href="{{ '/' | url }}" class="sg-header__logo">
          <img src="{{ site.organization.logo | url }}" alt="Scottish Government" class="sg-header__logo-image">
        </a>
      </div>
      <div class="sg-header__search">
        <form class="sg-header__search-form" role="search" action="{{ '/search' | url }}" method="get">
          <label for="search-input" class="sg-header__search-label">Search</label>
          <input type="search" id="search-input" name="q" class="sg-header__search-input" placeholder="Search">
          <button type="submit" class="sg-header__search-button">Search</button>
        </form>
      </div>
    </div>
  </header>

  {# Main navigation #}
  <nav class="site-nav" role="navigation" aria-label="Main navigation">
    <div class="site-nav__wrapper">
      <ul class="site-nav__list" id="nav-menu">
        {% for item in site.navigation %}
          {% set isActive = (item.url == page.url) %}
          <li class="site-nav__item">
            <a href="{{ item.url | url }}" class="site-nav__link{% if isActive %} site-nav__link--active{% endif %}">
              {{ item.text }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>
  </nav>

  <div class="container">
    {# Optional sidebar (unchanged if you use it) #}
    {% if collections.all | length > 1 %}
    <aside class="sidebar" role="complementary" aria-label="Page navigation">
      <h2 class="sidebar__title">On this page</h2>
      <nav class="sidebar__nav" aria-label="Page contents">
        <ul class="sidebar__nav">
          <li class="sidebar__nav-item">
            <a href="#" class="sidebar__nav-link" id="toc-placeholder">Contents loading...</a>
          </li>
        </ul>
      </nav>

      <hr style="margin:1.5rem 0;border:none;border-top:1px solid var(--sg-border-grey);">
      <h3 class="sidebar__title">All pages</h3>
      <ul class="sidebar__nav">
        {% for p in collections.all %}
          {% if p.url and p.url != "/" %}
          <li class="sidebar__nav-item">
            <a href="{{ p.url | url }}" class="sidebar__nav-link{% if p.url == page.url %} sidebar__nav-link--active{% endif %}">
              {{ p.data.title or p.data.eleventyNavigation.title or "Untitled" }}
            </a>
          </li>
          {% endif %}
        {% endfor %}
      </ul>
    </aside>
    {% endif %}

    <main class="main" id="main-content" role="main" tabindex="-1">
      {% if title %}<h1>{{ title }}</h1>{% endif %}
      {% if description and title %}<p class="lead">{{ description }}</p>{% endif %}

      {{ content | safe }}

      {% if page.date %}
      <footer class="content-footer"><p><small>Last updated: {{ page.date | dateDisplay }}</small></p></footer>
      {% endif %}
    </main>
  </div>

  <footer class="sg-footer" role="contentinfo">
    <!-- your footer blocks as before -->
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
  <script src="{{ '/js/search.js' | url }}"></script>
</body>
</html>
