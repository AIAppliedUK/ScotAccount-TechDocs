
@startuml OIDC Flow with PKCE and Error Handling (with Failure Modes)

skinparam noteBackgroundColor #FEFECE
skinparam noteBorderColor #999999

actor "User Browser" as Browser
actor "New Browser (via email link)" as NewBrowser
participant "Spring Application" as App
participant "OpenID Provider" as OP
participant "Token Endpoint" as Token
participant "UserInfo Endpoint" as UserInfo
participant "JWKS Endpoint" as JWKS
participant "Verified Claims Endpoint" as VCE

== Initial Login Request ==
Browser -> App: 1. GET /oauth2/authorization/scotaccount
App -> App: 2. Generate PKCE
App -> App: 3. Store in session (state, nonce, code_verifier)

== Authorization Redirect ==
App --> Browser: 4. 302 Redirect to /authorize?state=<state>

== User Authentication ==
Browser -> OP: 5. GET /authorize
OP -> Browser: 6. Show login page
Browser -> OP: 7. POST /authorize (username/password)
OP -> Browser: 8. Set consent cookie

== Authorization Code Return ==
OP --> Browser: 9. 302 Redirect to /login/oauth2/code/scotaccount?code=...&state=...

alt **Scenario A - Same Browser**

    Browser -> App: 10. GET /login/oauth2/code (with JSESSIONID)
    App -> Token: 11. POST /token (code + code_verifier)
    Token --> App: 12. Tokens issued
    App -> App: 13. Process tokens, fetch claims
    App -> VCE: 14. GET /attributes/values
    VCE --> App: 15. claims JSON
    App -> JWKS: 16. GET /jwks
    JWKS --> App: 17. Keys
    App -> App: 18. Validate and create new session
    App --> Browser: 19. 302 /
    Browser -> App: 20. GET /
    App --> Browser: 21. Home Page

else **Scenario B - Browser switch via email**

    note over NewBrowser
      ⚠ Failure Mode: Email link opened in a different browser.
      Session cookie (JSESSIONID) is missing.
    end note
    NewBrowser -> App: 10b. GET /login/oauth2/code (NO session)
    App --> NewBrowser: 11b. 302 /?error=invalid_state

else **Scenario C - Session timeout before return**

    note over Browser
      ⚠ Failure Mode: User took too long verifying.
      Spring session expired before return.
    end note
    Browser -> App: 10c. GET /login/oauth2/code (STALE session)
    App --> Browser: 11c. 302 /?error=invalid_state

end

@enduml
