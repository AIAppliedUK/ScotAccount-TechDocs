@startuml
title ScotAccount OIDC Mobile Flow with Matched Risk Annotations

actor User
participant "Mobile App (Public Client)" as App
participant "Authorisation Endpoint (/authorize)" as Authorise
participant "Token Endpoint (/token)" as Token
participant "Attribute Endpoint (/attributes/values)" as Attributes

== Step 1: Authentication ==
User -> App : [0] Start login
App -> Authorise : [1] Authorisation request (openid, PKCE, redirect_uri)
note right of App
⚠ Risk 3: Redirect URI mix-up or open redirect
end note

Authorise -> User : [2] Prompt for login and consent
User -> Authorise : Enter credentials and approve
Authorise -> App : [3] Redirect with authorisation code
note right of App
⚠ Risk 2: Code interception risk (e.g. URI hijack)
⚠ Risk 3: Redirect URI issues
end note

App -> Token : [4] Token request (code, verifier, client_assertion)
Token -> App : [5] ID Token / Access Token
note right of App
⚠ Risk 1: Insecure token storage on device
end note

== Step 2: Requesting Verified Attributes ==
App -> Authorise : [6] Auth request (openid + attribute scopes)
Authorise -> User : [7] Prompt for attribute consent
User -> Authorise : Provide consent
Authorise -> App : [8] Redirect with new auth code
note right of App
⚠ Risk 2: Code interception
⚠ Risk 3: Redirect URI manipulation
end note

App -> Token : [9] Token request for attributes
Token -> App : [10] Attribute access token

App -> Attributes : [11] Request verified attributes
note right of Attributes
⚠ Risk 5: Token replay if not sender-constrained (use DPoP/mTLS)
⚠ Risk 6: Mix-up/Cuckoo if audience/issuer unchecked
end note

Attributes -> App : [12] Return verified data

@enduml