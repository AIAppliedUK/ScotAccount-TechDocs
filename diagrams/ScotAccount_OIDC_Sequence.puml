@startuml
actor User
participant "Relying Party (RP)" as RP
participant "ScotAccount Authorisation Server" as AS
participant "ScotAccount Token Endpoint" as Token
participant "ScotAccount Attribute Endpoint" as Attributes

== Initial Authentication Flow ==
User -> RP : Access Login Page
RP -> AS : Redirect to /authorize (scope=openid)
(PKCE, client_id, redirect_uri)
AS -> User : Prompt for credentials & consent
User -> AS : Submit credentials
AS -> RP : Redirect with auth code

RP -> Token : POST /token
(auth code, code_verifier, client_assertion)
(client authenticates via private_key_jwt)
Token -> RP : Return access_token, id_token

== Attribute Request Flow ==
User -> RP : Requests additional services
RP -> AS : Redirect to /authorize
(scope=openid scotaccount.gpg45.medium ...)
AS -> User : Prompt for consent to share attributes
User -> AS : Approves
AS -> RP : Redirect with new auth code

RP -> Token : POST /token
(auth code, code_verifier, client_assertion)
Token -> RP : Return new access_token

RP -> Attributes : POST /attributes/values
(access_token with relevant scopes)
Attributes -> RP : Return verified attributes
(identity, email, address)

@enduml