@startuml
title ScotAccount Mobile Client OIDC Flow with Endpoint and Risk Annotations

actor User
participant "Mobile App (Public Client)" as App
participant "Authorisation Endpoint
(/authorize)" as Authorise
participant "Token Endpoint
(/token)" as Token
participant "Attribute Endpoint
(/attributes/values)" as Attributes

== Step 1: User Authentication ==
User -> App : [0] Open App / Start Login
App -> Authorise : [1] Authorisation Request (openid, PKCE, redirect_uri)
note right of App
⚠ [1–3] Risk of redirect URI mix-up or open redirect
end note

Authorise -> User : [2] Prompt for login and consent
User -> Authorise : Submit credentials and consent
Authorise -> App : [3] Redirect with authorisation code
note right of App
⚠ [3] Risk of code interception (e.g. custom URI hijack)
end note

App -> Token : [4] Token Request (code, code_verifier, client_assertion)
Token -> App : [5] ID Token / Access Token
note right of App
⚠ [5] Token must be securely stored on device
end note

== Step 2: Requesting Verified Attributes ==
App -> Authorise : [6] Auth request (openid + attribute scopes)
Authorise -> User : [7] Prompt for attribute consent
User -> Authorise : Consent to attribute sharing
Authorise -> App : [8] Redirect with new auth code

App -> Token : [9] Token Request (code, code_verifier, client_assertion)
Token -> App : [10] Access Token (for attributes)

App -> Attributes : [11] Request verified attributes (access_token)
note right of Attributes
⚠ [11] Risk of token replay if not sender-constrained (use DPoP/mTLS)
end note

Attributes -> App : [12] Return verified data

@enduml