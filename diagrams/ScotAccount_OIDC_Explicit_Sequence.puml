@startuml
title ScotAccount OIDC Authentication and Attribute Access Flow

actor User
participant "Relying Party (Mobile App)" as RP
participant "ScotAccount Authorisation Endpoint (/authorize)" as Authorise
participant "ScotAccount Token Endpoint (/token)" as Token
participant "ScotAccount Attribute Endpoint (/attributes/values)" as Attributes

== Step 1: Initial Authentication ==
User -> RP : Opens app / initiates login
RP -> Authorise : Redirect with auth request
(scope=openid, client_id, code_challenge, redirect_uri)
Authorise -> User : Prompt for login + consent
User -> Authorise : Enters credentials and consents
Authorise -> RP : Redirect with auth code

RP -> Token : POST /token
(code, code_verifier, client_assertion)
Token -> RP : Returns id_token, access_token

== Step 2: Request Verified Attributes ==
User -> RP : Triggers journey needing verified attributes
RP -> Authorise : Redirect with new auth request
(scope=openid scotaccount.gpg45.medium ...)

Authorise -> User : Consent prompt for attributes
User -> Authorise : Consents
Authorise -> RP : Redirect with new auth code

RP -> Token : POST /token
(code, code_verifier, client_assertion)
Token -> RP : Returns access_token

RP -> Attributes : POST /attributes/values
(Authorization: Bearer access_token)
Attributes -> RP : Returns JSON with verified attributes

@enduml