<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Implementation Guide | ScotAccount Technical Documentation</title>
  <meta name="description" content="Technical guide for implementing ScotAccount authentication and verified attributes">
  <link rel="canonical" href="https://scotaccount.github.io/sg-identity-techdocs/scotaccount-guide/">
  
  <!-- Scottish Government favicons -->
  <link rel="icon" type="image/x-icon" href="/sg-identity-techdocs/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/sg-identity-techdocs/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/sg-identity-techdocs/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/sg-identity-techdocs/favicon-16x16.png">
  <link rel="mask-icon" href="/sg-identity-techdocs/safari-pinned-tab.svg" color="#0065bd">

  <!-- Styles -->
  <link rel="stylesheet" href="/sg-identity-techdocs/css/main.css">
  
  <!-- Open Graph -->
  <meta property="og:title" content="Implementation Guide">
  <meta property="og:description" content="Technical guide for implementing ScotAccount authentication and verified attributes">
  <meta property="og:type" content="website">
  <meta property="og:url" content="/scotaccount-guide/">
  <meta property="og:image" content="apple-touch-icon.png">
  
  <!-- Schema.org -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "TechArticle",
    "headline": "Implementation Guide",
    "description": "Technical guide for implementing ScotAccount authentication and verified attributes",
    "author": {
      "@type": "Organization",
      "name": "Scottish Government",
      "url": "https://www.gov.scot"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Scottish Government",
      "url": "https://www.gov.scot"
    }
  }
  </script>
</head>
<body>
  <!-- Cookie Banner (Scottish Government Style) -->
  <div class="cookie-banner" id="cookie-banner" role="region" aria-labelledby="cookie-banner-heading">
    <div class="cookie-banner__container">
      <div class="cookie-banner__content">
        <h2 id="cookie-banner-heading" class="cookie-banner__heading">Information</h2>
        <p class="cookie-banner__text">We use <a href="#cookies" class="cookie-banner__link">cookies</a> to collect anonymous data to help us improve your site browsing experience.</p>
        <p class="cookie-banner__text">Click 'Accept all cookies' to agree to all cookies that collect anonymous data. To only allow the cookies that make the site work, click 'Use essential cookies only.' Visit 'Set cookie preferences' to control specific cookies.</p>
      </div>
      <div class="cookie-banner__actions">
        <button type="button" class="cookie-banner__button cookie-banner__button--primary" onclick="acceptAllCookies()">Accept all cookies</button>
        <button type="button" class="cookie-banner__button cookie-banner__button--secondary" onclick="useEssentialCookies()">Use essential cookies only</button>
        <button type="button" class="cookie-banner__button cookie-banner__button--link" onclick="setCookiePreferences()">Set cookie preferences</button>
      </div>
    </div>
  </div>

  <!-- Skip to main content for accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Scottish Government Identity Header (blue) -->
  <header class="sg-header" role="banner">
    <div class="sg-header__wrapper">
      <div class="sg-header__branding">
        <a href="/sg-identity-techdocs/" class="sg-header__logo">
          <img src="/sg-identity-techdocs/assets/scotgovlogo.svg" alt="Scottish Government">
        </a>
      </div>
      <div class="sg-header__search">
        <form class="sg-header__search-form" role="search" action="/sg-identity-techdocs/search" method="get">
          <label for="search-input" class="sg-header__search-label">Search</label>
          <input type="search" id="search-input" name="q" class="sg-header__search-input" placeholder="Search">
          <button type="submit" class="sg-header__search-button">
            <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
              <path fill="currentColor" d="M15.504 13.616l-3.79-3.223c-0.392-0.353-0.811-0.514-1.149-0.499 0.895-1.048 1.435-2.407 1.435-3.893 0-3.314-2.686-6-6-6s-6 2.686-6 6 2.686 6 6 6c1.486 0 2.845-0.54 3.893-1.435-0.016 0.338 0.146 0.757 0.499 1.149l3.223 3.79c0.552 0.613 1.453 0.665 2.003 0.115s0.498-1.452-0.115-2.003zM6 10c-2.209 0-4-1.791-4-4s1.791-4 4-4 4 1.791 4 4-1.791 4-4 4z"/>
            </svg>
            <span class="sg-visually-hidden">Search</span>
          </button>
        </form>
      </div>
    </div>
  </header>
  <!-- Site Navigation Header (white) -->
  <nav class="site-nav" role="navigation" aria-label="Main navigation">
    <div class="site-nav__wrapper">
      <ul class="site-nav__list" id="nav-menu">
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/" class="site-nav__link">Home</a>
          </li>
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/getting-started/" class="site-nav__link">Getting Started</a>
          </li>
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/architecture/" class="site-nav__link">Architecture</a>
          </li>
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/scotaccount-guide/" class="site-nav__link site-nav__link--active">Implementation Guide</a>
          </li>
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/scotaccount-complete-guide/" class="site-nav__link">Comprehensive Guide</a>
          </li>
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/scotaccount-token-validation-module/" class="site-nav__link">Token Validation</a>
          </li>
        
      </ul>
    </div>
  </nav>

  <!-- Main layout container -->
  <div class="container">
    <!-- Sidebar with page-specific navigation -->
    
    <aside class="sidebar" role="complementary" aria-label="Page navigation">
      <h2 class="sidebar__title">On this page</h2>
      <nav class="sidebar__nav" aria-label="Page contents">
        <ul class="sidebar__nav">
          <!-- Table of contents will be injected here via JavaScript -->
          <li class="sidebar__nav-item">
            <a href="#" class="sidebar__nav-link" id="toc-placeholder">
              Contents loading...
            </a>
          </li>
        </ul>
      </nav>
      
      
      <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--sg-border-grey);">
      <h3 class="sidebar__title">All pages</h3>
      <ul class="sidebar__nav">
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/architecture/" 
              class="sidebar__nav-link">
              ScotAccount Architecture Overview
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/getting-started/" 
              class="sidebar__nav-link">
              Getting Started with ScotAccount
            </a>
          </li>
          
        
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/integration-examples/" 
              class="sidebar__nav-link">
              Integration Examples and Best Practices
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/scotaccount-complete-guide/" 
              class="sidebar__nav-link">
              Comprehensive Guide
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/scotaccount-guide/" 
              class="sidebar__nav-link">
              Implementation Guide
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/scotaccount-modular-structure/" 
              class="sidebar__nav-link">
              ScotAccount Modular Structure
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/scotaccount-token-validation-module/" 
              class="sidebar__nav-link">
              Token Validation Module
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/search/" 
              class="sidebar__nav-link">
              Search results
            </a>
          </li>
          
        
      </ul>
      
    </aside>
    

    <!-- Main content -->
    <main class="main" id="main-content" role="main" tabindex="-1">
      
        <h1>Implementation Guide</h1>
      
      
      
        <p class="lead">Technical guide for implementing ScotAccount authentication and verified attributes</p>
      

      <!-- Page content -->
      <p>This guide provides technical implementation instructions for integrating with ScotAccount. Follow these steps to build secure authentication with optional verified attributes.</p>
<p><div class="table-of-contents"><ul><li><a href="#implementation-overview">Implementation Overview</a></li><li><a href="#phase-1-setup-and-registration">Phase 1: Setup &amp; Registration</a><ul><li><a href="#generate-cryptographic-keys">Generate Cryptographic Keys</a></li><li><a href="#secure-key-storage">Secure Key Storage</a></li><li><a href="#service-registration">Service Registration</a></li><li><a href="#registration-response">Registration Response</a></li></ul></li><li><a href="#phase-2-basic-authentication">Phase 2: Basic Authentication</a><ul><li><a href="#discovery-endpoint-integration">Discovery Endpoint Integration</a></li><li><a href="#pkce-implementation">PKCE Implementation</a></li><li><a href="#authorization-request">Authorization Request</a></li><li><a href="#callback-handler">Callback Handler</a></li><li><a href="#jwt-client-assertion">JWT Client Assertion</a></li><li><a href="#token-exchange">Token Exchange</a></li><li><a href="#id-token-validation">ID Token Validation</a></li></ul></li><li><a href="#phase-3-verified-attributes">Phase 3: Verified Attributes</a><ul><li><a href="#requesting-additional-scopes">Requesting Additional Scopes</a></li></ul></li><li><a href="#phase-4-production-deployment">Phase 4: Production Deployment</a><ul><li><a href="#environment-configuration">Environment Configuration</a></li><li><a href="#monitoring-and-logging">Monitoring and Logging</a></li><li><a href="#error-handling">Error Handling</a></li><li><a href="#security-checklist">Security Checklist</a></li></ul></li><li><a href="#complete-example-implementation">Complete Example Implementation</a></li><li><a href="#troubleshooting-common-issues">Troubleshooting Common Issues</a><ul><li><a href="#invalid-client-assertion">Invalid Client Assertion</a></li><li><a href="#state-parameter-mismatch">State Parameter Mismatch</a></li><li><a href="#token-validation-failures">Token Validation Failures</a></li><li><a href="#pkce-errors">PKCE Errors</a></li></ul></li><li><a href="#support-and-next-steps">Support and Next Steps</a></li></ul></div></p>
<h2 id="implementation-overview" tabindex="-1"><a class="header-anchor" href="#implementation-overview"><span>Implementation Overview</span></a></h2>
<p>ScotAccount integration follows a four-phase approach:</p>
<ol>
<li><strong>Setup &amp; Registration</strong> - Generate keys and register your service</li>
<li><strong>Basic Authentication</strong> - Implement OpenID Connect authentication flow</li>
<li><strong>Verified Attributes</strong> - Add identity, address, and email verification</li>
<li><strong>Production Deployment</strong> - Go live with monitoring and security measures</li>
</ol>
<h2 id="phase-1-setup-and-registration" tabindex="-1"><a class="header-anchor" href="#phase-1-setup-and-registration"><span>Phase 1: Setup &amp; Registration</span></a></h2>
<h3 id="generate-cryptographic-keys" tabindex="-1"><a class="header-anchor" href="#generate-cryptographic-keys"><span>Generate Cryptographic Keys</span></a></h3>
<p><strong>EC Key Pair</strong>:</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Generate EC private key</span>
openssl ecparam <span class="token parameter variable">-genkey</span> <span class="token parameter variable">-name</span> prime256v1 <span class="token parameter variable">-out</span> ec_private_key.pem

<span class="token comment"># Extract public key</span>
openssl ec <span class="token parameter variable">-in</span> ec_private_key.pem <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> ec_public_key.pem</code></pre>
<h3 id="secure-key-storage" tabindex="-1"><a class="header-anchor" href="#secure-key-storage"><span>Secure Key Storage</span></a></h3>
<p>Store private keys securely using a secrets manager. You dont have to use keyvault or secrets manager but it must not be in your application codebase:</p>
<p><strong>AWS Secrets Manager</strong>:</p>
<pre class="language-bash"><code class="language-bash">aws secretsmanager create-secret <span class="token punctuation">\</span>
  <span class="token parameter variable">--name</span> <span class="token string">"scotaccount/private-key"</span> <span class="token punctuation">\</span>
  --secret-string file://private_key.pem</code></pre>
<p><strong>Azure Key Vault</strong>:</p>
<pre class="language-bash"><code class="language-bash">az keyvault secret <span class="token builtin class-name">set</span> <span class="token punctuation">\</span>
  --vault-name <span class="token string">"your-keyvault"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--name</span> <span class="token string">"scotaccount-private-key"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--file</span> private_key.pem</code></pre>
<h3 id="service-registration" tabindex="-1"><a class="header-anchor" href="#service-registration"><span>Service Registration</span></a></h3>
<p>Submit these details to the ScotAccount team:</p>
<p><strong>Required Information</strong>:</p>
<ul>
<li><strong>Service name</strong> and description</li>
<li><strong>Public key</strong> (from generated key pair)</li>
<li><strong>Redirect URIs</strong> (where users return after authentication)</li>
<li><strong>Post-logout redirect URIs</strong> (where users go after logout)</li>
<li><strong>Required scopes</strong> (see scope reference below)</li>
<li><strong>Production IP addresses</strong> (To secure token ex)</li>
<li><strong>Technical contact</strong> details</li>
</ul>
<p><strong>Scope Reference</strong>:</p>
<ul>
<li><code>openid</code> - Required for all integrations</li>
<li><code>scotaccount.gpg45.medium</code> - Verified identity (GPG45 Medium)</li>
<li><code>scotaccount.address</code> - Verified postal address</li>
<li><code>scotaccount.email</code> - Verified email address</li>
<li><code>scotaccount.mobile</code> - Verified mobile number</li>
</ul>
<h3 id="registration-response" tabindex="-1"><a class="header-anchor" href="#registration-response"><span>Registration Response</span></a></h3>
<p>You’ll receive:</p>
<ul>
<li><strong>Client ID</strong> - Your unique service identifier</li>
<li><strong>Configuration URLs</strong> - Integration and production endpoints</li>
<li><strong>Testing credentials</strong> - For development environment access</li>
</ul>
<h2 id="phase-2-basic-authentication" tabindex="-1"><a class="header-anchor" href="#phase-2-basic-authentication"><span>Phase 2: Basic Authentication</span></a></h2>
<p><img src="/sg-identity-techdocs/assets/diagrams/auth-flow.png" alt="ScotAccount High-Level Architecture"></p>
<p><em>Figure: Illustration of authentication flow.</em></p>
<h3 id="discovery-endpoint-integration" tabindex="-1"><a class="header-anchor" href="#discovery-endpoint-integration"><span>Discovery Endpoint Integration</span></a></h3>
<p>Always retrieve current configuration dynamically from the discovery endpoint:</p>
<p><strong>Discovery Endpoint URL:</strong></p>
<pre><code>https://authz.integration.scotaccount.service.gov.scot/.well-known/openid-configuration
</code></pre>
<p><strong>Example Discovery Response:</strong></p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"issuer"</span><span class="token operator">:</span> <span class="token string">"https://authz.integration.scotaccount.service.gov.scot"</span><span class="token punctuation">,</span>
  <span class="token property">"authorization_endpoint"</span><span class="token operator">:</span> <span class="token string">"https://authz.integration.scotaccount.service.gov.scot/authorize"</span><span class="token punctuation">,</span>
  <span class="token property">"token_endpoint"</span><span class="token operator">:</span> <span class="token string">"https://authz.integration.scotaccount.service.gov.scot/token"</span><span class="token punctuation">,</span>
  <span class="token property">"jwks_uri"</span><span class="token operator">:</span> <span class="token string">"https://authz.integration.scotaccount.service.gov.scot/jwks.json"</span><span class="token punctuation">,</span>
  <span class="token property">"registration_endpoint"</span><span class="token operator">:</span> <span class="token string">"https://authz.integration.scotaccount.service.gov.scot/register"</span><span class="token punctuation">,</span>
  <span class="token property">"scopes_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"openid"</span><span class="token punctuation">,</span>
    <span class="token string">"scotaccount.email"</span><span class="token punctuation">,</span>
    <span class="token string">"scotaccount.gpg45.medium"</span><span class="token punctuation">,</span>
    <span class="token string">"scotaccount.address"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"response_types_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"response_modes_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"query"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"grant_types_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"authorization_code"</span><span class="token punctuation">,</span> <span class="token string">"refresh_token"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"subject_types_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"pairwise"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"id_token_signing_alg_values_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"RS256"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"token_endpoint_auth_methods_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"private_key_jwt"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"token_endpoint_auth_signing_alg_values_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"RS256"</span><span class="token punctuation">,</span> <span class="token string">"ES256"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"claims_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"sub"</span><span class="token punctuation">,</span> <span class="token string">"iss"</span><span class="token punctuation">,</span> <span class="token string">"aud"</span><span class="token punctuation">,</span> <span class="token string">"exp"</span><span class="token punctuation">,</span> <span class="token string">"iat"</span><span class="token punctuation">,</span> <span class="token string">"nonce"</span><span class="token punctuation">,</span> <span class="token string">"sid"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>Key configuration values</strong>:</p>
<ul>
<li><code>authorization_endpoint</code> - Where to send authentication requests</li>
<li><code>token_endpoint</code> - Where to exchange codes for tokens</li>
<li><code>jwks_uri</code> - Public keys for token validation</li>
</ul>
<div class="callout callout--info">
<strong>Implementation needed?</strong> See the <a href="/sg-identity-techdocs/integration-examples/#discovery-endpoint-integration">Discovery Endpoint Integration</a> example for code implementation.
</div>
<h3 id="pkce-implementation" tabindex="-1"><a class="header-anchor" href="#pkce-implementation"><span>PKCE Implementation</span></a></h3>
<p>Generate PKCE parameters for security. Your application must create:</p>
<ul>
<li><strong>Code verifier</strong>: Random string between 43-128 characters (e.g., <code>dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk</code>)</li>
<li><strong>Code challenge</strong>: SHA256 hash of the verifier, base64url encoded (e.g., <code>E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM</code>)</li>
<li><strong>Code challenge method</strong>: Always <code>S256</code></li>
</ul>
<div class="callout callout--info">
<strong>Implementation needed?</strong> See the <a href="/sg-identity-techdocs/integration-examples/#pkce-implementation">PKCE Implementation</a> example for code implementation.
</div>
<h3 id="authorization-request" tabindex="-1"><a class="header-anchor" href="#authorization-request"><span>Authorization Request</span></a></h3>
<p>Build the authentication URL with all required parameters:</p>
<p><strong>Authorization Endpoint URL:</strong></p>
<pre><code>https://authz.integration.scotaccount.service.gov.scot/authorize
</code></pre>
<p><strong>Complete Authorization Request Example:</strong></p>
<pre><code>GET https://authz.integration.scotaccount.service.gov.scot/authorize?
    client_id=your-client-id&amp;
    redirect_uri=https://yourservice.gov.scot/auth/callback&amp;
    response_type=code&amp;
    scope=openid&amp;
    state=af0ifjsldkj-unique-state-value&amp;
    nonce=n-0S6_WzA2Mj-unique-nonce-value&amp;
    code_challenge=E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM&amp;
    code_challenge_method=S256
</code></pre>
<p>Each parameter serves a specific purpose:</p>
<ul>
<li><strong>client_id</strong>: Your unique identifier assigned during registration</li>
<li><strong>redirect_uri</strong>: Where ScotAccount sends users after authentication</li>
<li><strong>response_type</strong>: Always <code>code</code> for the authorization code flow</li>
<li><strong>scope</strong>: Space-separated list of requested permissions</li>
<li><strong>state</strong>: Random value for CSRF protection</li>
<li><strong>nonce</strong>: Random value for replay protection</li>
<li><strong>code_challenge</strong>: SHA256 hash of your code verifier, base64url encoded</li>
<li><strong>code_challenge_method</strong>: Always <code>S256</code> for SHA256</li>
</ul>
<div class="callout callout--info">
<strong>Implementation needed?</strong> See the <a href="/sg-identity-techdocs/integration-examples/#authorization-request-builder">Authorization Request Builder</a> example for code implementation.
</div>
<h3 id="callback-handler" tabindex="-1"><a class="header-anchor" href="#callback-handler"><span>Callback Handler</span></a></h3>
<p>Process the authentication response from ScotAccount:</p>
<p><strong>Example Callback URL:</strong></p>
<pre><code>https://yourservice.gov.scot/auth/callback?
    code=SplxlOBeZQQYbYS6WxSbIA&amp;
    state=af0ifjsldkj
</code></pre>
<p>Your application must:</p>
<ol>
<li>Extract the authorization code and state parameter</li>
<li>Validate the state parameter matches your stored value</li>
<li>Handle any error responses appropriately</li>
</ol>
<div class="callout callout--info">
<strong>Implementation needed?</strong> See the <a href="/sg-identity-techdocs/integration-examples/#callback-handler">Callback Handler</a> example for code implementation.
</div>
<h3 id="jwt-client-assertion" tabindex="-1"><a class="header-anchor" href="#jwt-client-assertion"><span>JWT Client Assertion</span></a></h3>
<p>Create signed JWT for token exchange to prove your service’s identity:</p>
<p><strong>Client Assertion JWT Payload Example:</strong></p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"your-client-id"</span><span class="token punctuation">,</span>
  <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"your-client-id"</span><span class="token punctuation">,</span>
  <span class="token property">"aud"</span><span class="token operator">:</span> <span class="token string">"https://authz.integration.scotaccount.service.gov.scot/token"</span><span class="token punctuation">,</span>
  <span class="token property">"exp"</span><span class="token operator">:</span> <span class="token number">1757847083</span><span class="token punctuation">,</span>
  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1741953083</span><span class="token punctuation">,</span>
  <span class="token property">"jti"</span><span class="token operator">:</span> <span class="token string">"239a5659-0533-4faa-ba97-8f6ee057843f"</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>Signed JWT Example:</strong></p>
<pre><code>eyJhbGciOiJSUzI1NiJ9.eyJzdWIiOiI2b3ZmeHRqYWl2bHB5Iiw...
</code></pre>
<div class="callout callout--info">
<strong>Implementation needed?</strong> See the <a href="/sg-identity-techdocs/integration-examples/#jwt-client-assertion">JWT Client Assertion</a> example for code implementation.
</div>
<h3 id="token-exchange" tabindex="-1"><a class="header-anchor" href="#token-exchange"><span>Token Exchange</span></a></h3>
<p>Exchange authorization code for tokens:</p>
<p><strong>Token Endpoint URL:</strong></p>
<pre><code>https://authz.integration.scotaccount.service.gov.scot/token
</code></pre>
<p><strong>Token Exchange Request Example:</strong></p>
<pre class="language-http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/token</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">authz.integration.scotaccount.service.gov.scot</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>

grant_type=authorization_code&amp;
code=SplxlOBeZQQYbYS6WxSbIA&amp;
redirect_uri=https://yourservice.gov.scot/auth/callback&amp;
client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer&amp;
client_assertion=eyJhbGciOiJSUzI1NiJ9.eyJzdWIiOiI2b3ZmeHRq...&amp;
code_verifier=dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk</code></pre>
<p><strong>Success Response Example:</strong></p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"access_token"</span><span class="token operator">:</span> <span class="token string">"eyJraWQiOiJXZ2lHIiwidHlwIjoiYXQrand0IiwiYWxnIjoiUlMyNTYifQ..."</span><span class="token punctuation">,</span>
  <span class="token property">"refresh_token"</span><span class="token operator">:</span> <span class="token string">"eyJlbmMiOiJBMTI4Q0JDLUhTMjU2IiwiYWxnIjoiZGlyIn0..."</span><span class="token punctuation">,</span>
  <span class="token property">"id_token"</span><span class="token operator">:</span> <span class="token string">"eyJraWQiOiJXZ2lHIiwiYWxnIjoiUlMyNTYifQ..."</span><span class="token punctuation">,</span>
  <span class="token property">"token_type"</span><span class="token operator">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span>
  <span class="token property">"expires_in"</span><span class="token operator">:</span> <span class="token number">900</span><span class="token punctuation">,</span>
  <span class="token property">"scope"</span><span class="token operator">:</span> <span class="token string">"openid"</span>
<span class="token punctuation">}</span></code></pre>
<div class="callout callout--info">
<strong>Implementation needed?</strong> See the <a href="/sg-identity-techdocs/integration-examples/#token-exchange">Token Exchange</a> example for code implementation.
</div>
<h3 id="id-token-validation" tabindex="-1"><a class="header-anchor" href="#id-token-validation"><span>ID Token Validation</span></a></h3>
<p>Validate and extract user information from the ID token:</p>
<p><strong>Example ID Token (Encoded):</strong></p>
<pre><code>eyJraWQiOiJXZ2lHIiwiYWxnIjoiUlMyNTYifQ.eyJzdWIiOiI0ZjY4OTNmNC02ZmJlLTQyM2UtYTVjYy1kM2M5M2U1YTdjNDEiLCJhdWQiOiI1eWh5Z2tzY3R3cHFnIiwiaXNzIjoiaHR0cHM6Ly9hdXRoei5pbnRlZ3JhdGlvbi5zY290YWNjb3VudC5zZXJ2aWNlLmdvdi5zY290IiwiZXhwIjoxNjc4OTMyNjYyLCJpYXQiOjE2Nzg5MzE3NjIsIm5vbmNlIjoiQmRITERXUFJtWThXQllONkJFdEZmSTJSVm9KbXlDUnBwR0ZJdDJoR3k3QSIsImp0aSI6ImZQX1hfMnc2NWlVIiwic2lkIjoieXhaMlZwT255ZFYwQ1Q4ajFTYmxmenRSWURya3EtU0ozT0g3ZWpGN0dRZyJ9.db79iKccqKkXF4MF2IThOV05AZHrlvmNZWAW5ojUzyQoKzHSlPtCEeC3sqwsah84gHMqU0A9ACWPbE8SECdpzOvL6QVCfoWjwuiMEzMsOZvCHccMEpeNX8rbB7_L5Mo5lLOpVl80jIezKNQJ8NMQoOgMGaBm5qkgLTVFuYqVnvpzAEb44xDeSYe7__jaXOUBiGIWMqopeqJRmR1cy5yJ9ShqDa_xoBVmAxXXXv0ZOanE7E7-LCBApdvFNRA-JUUrjMIYUNn8cSkupye6bjLElLT_qPKJc6N0mSOhH43oU5GB-heMhNX18p-07J5pFFAHotcP6VsA2mE7y96gLQ1XrA
</code></pre>
<p><strong>Decoded Header:</strong></p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"kid"</span><span class="token operator">:</span> <span class="token string">"WgiG"</span><span class="token punctuation">,</span>
  <span class="token property">"alg"</span><span class="token operator">:</span> <span class="token string">"RS256"</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>Decoded Payload:</strong></p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"4f6893f4-6fbe-423e-a5cc-d3c93e5a7c41"</span><span class="token punctuation">,</span>
  <span class="token property">"aud"</span><span class="token operator">:</span> <span class="token string">"5yhygksctwpqg"</span><span class="token punctuation">,</span>
  <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"https://authz.integration.scotaccount.service.gov.scot"</span><span class="token punctuation">,</span>
  <span class="token property">"exp"</span><span class="token operator">:</span> <span class="token number">1678932662</span><span class="token punctuation">,</span>
  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1678931762</span><span class="token punctuation">,</span>
  <span class="token property">"nonce"</span><span class="token operator">:</span> <span class="token string">"BdHLDWPRmY8WBYN6BEtFfI2RVoJmyCRppGFIt2hGy7A"</span><span class="token punctuation">,</span>
  <span class="token property">"jti"</span><span class="token operator">:</span> <span class="token string">"fP_X_2w65iU"</span><span class="token punctuation">,</span>
  <span class="token property">"sid"</span><span class="token operator">:</span> <span class="token string">"yxZ2VpOnydV0CT8j1SblfztRYDrkq-SJ3OH7ejF7GQg"</span>
<span class="token punctuation">}</span></code></pre>
<p>Your application must validate:</p>
<ul>
<li>JWT signature using ScotAccount’s public keys</li>
<li>Token expiration time</li>
<li>Issuer matches ScotAccount’s identifier</li>
<li>Audience matches your client ID</li>
<li>Nonce matches your original request</li>
</ul>
<div class="callout callout--info">
<strong>Implementation needed?</strong> See the <a href="/sg-identity-techdocs/integration-examples/#id-token-validation">ID Token Validation</a> example for code implementation.
</div>
<h2 id="phase-3-verified-attributes" tabindex="-1"><a class="header-anchor" href="#phase-3-verified-attributes"><span>Phase 3: Verified Attributes</span></a></h2>
<h3 id="requesting-additional-scopes" tabindex="-1"><a class="header-anchor" href="#requesting-additional-scopes"><span>Requesting Additional Scopes</span></a></h3>
<p>To access verified attributes, request additional scopes in a new authorisation flow when required:</p>
<p><strong>Authorization Request with Additional Scopes:</strong></p>
<pre><code>https://authz.integration.scotaccount.service.gov.scot/authorize?
    client_id=your-client-id&amp;
    redirect_uri=https://yourservice.gov.scot/auth/callback&amp;
    response_type=code&amp;
    scope=openid%20scotaccount.email%20scotaccount.address%20scotaccount.gpg45.medium&amp;
    state=your-state&amp;
    nonce=your-nonce&amp;
    code_challenge=your-code-challenge&amp;
    code_challenge_method=S256
</code></pre>
<p>After exchanging the code for an access token, request attributes:</p>
<p><strong>Attribute Request:</strong></p>
<pre class="language-http"><code class="language-http">GET https://issuer.main.integration.scotaccount.service.gov.scot/attributes/values
<span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Bearer eyJraWQiOiJXZ2lHIiwidHlwIjoiYXQrand0Iiw...</span></span>
<span class="token header"><span class="token header-name keyword">DIS-Client-Assertion</span><span class="token punctuation">:</span> <span class="token header-value">eyJhbGciOiJSUzI1NiJ9.eyJzdWIiOiI2b3ZmeHRq...</span></span></code></pre>
<p><strong>Attribute Response Example:</strong></p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"claimsToken"</span><span class="token operator">:</span> <span class="token string">"eyJraWQiOiJkTVZEIiwiYWxnIjoiUlMyNTYifQ..."</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>Decoded Claims Token Structure:</strong></p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"iss"</span><span class="token operator">:</span> <span class="token string">"https://issuer.main.integration.scotaccount.service.gov.scot"</span><span class="token punctuation">,</span>
  <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"4f6893f4-6fbe-423e-a5cc-d3c93e5a7c41"</span><span class="token punctuation">,</span>
  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1678931762</span><span class="token punctuation">,</span>
  <span class="token property">"verified_claims"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"scope"</span><span class="token operator">:</span> <span class="token string">"scotaccount.gpg45.medium"</span><span class="token punctuation">,</span>
      <span class="token property">"verification"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"outcome"</span><span class="token operator">:</span> <span class="token string">"VERIFIED_SUCCESSFULLY"</span><span class="token punctuation">,</span>
        <span class="token property">"trust_framework"</span><span class="token operator">:</span> <span class="token string">"uk_tfida"</span><span class="token punctuation">,</span>
        <span class="token property">"assurance_policy"</span><span class="token operator">:</span> <span class="token string">"GPG_45"</span><span class="token punctuation">,</span>
        <span class="token property">"confidence_level"</span><span class="token operator">:</span> <span class="token string">"medium"</span><span class="token punctuation">,</span>
        <span class="token property">"time"</span><span class="token operator">:</span> <span class="token string">"2024-03-15T14:30:00Z"</span><span class="token punctuation">,</span>
        <span class="token property">"verifier"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"organization"</span><span class="token operator">:</span> <span class="token string">"ScotAccount"</span><span class="token punctuation">,</span>
          <span class="token property">"txn"</span><span class="token operator">:</span> <span class="token string">"a4dbe877-df63-4608-95b0-3a7fe3a4d751"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"claims"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"given_name"</span><span class="token operator">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span>
        <span class="token property">"family_name"</span><span class="token operator">:</span> <span class="token string">"Smith"</span><span class="token punctuation">,</span>
        <span class="token property">"birth_date"</span><span class="token operator">:</span> <span class="token string">"1990-05-15"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"scope"</span><span class="token operator">:</span> <span class="token string">"scotaccount.address"</span><span class="token punctuation">,</span>
      <span class="token property">"verification"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"outcome"</span><span class="token operator">:</span> <span class="token string">"VERIFIED_SUCCESSFULLY"</span><span class="token punctuation">,</span>
        <span class="token property">"trust_framework"</span><span class="token operator">:</span> <span class="token string">"uk_tfida"</span><span class="token punctuation">,</span>
        <span class="token property">"validation_method"</span><span class="token operator">:</span> <span class="token string">"credit_reference_agency"</span><span class="token punctuation">,</span>
        <span class="token property">"time"</span><span class="token operator">:</span> <span class="token string">"2024-03-15T14:30:00Z"</span><span class="token punctuation">,</span>
        <span class="token property">"verifier"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"organization"</span><span class="token operator">:</span> <span class="token string">"ScotAccount"</span><span class="token punctuation">,</span>
          <span class="token property">"txn"</span><span class="token operator">:</span> <span class="token string">"b5ece988-eg74-5719-a6c1-4b8gf4b5e862"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"claims"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"address"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"building_number"</span><span class="token operator">:</span> <span class="token string">"123"</span><span class="token punctuation">,</span>
          <span class="token property">"street_name"</span><span class="token operator">:</span> <span class="token string">"High Street"</span><span class="token punctuation">,</span>
          <span class="token property">"postal_code"</span><span class="token operator">:</span> <span class="token string">"EH1 1AA"</span><span class="token punctuation">,</span>
          <span class="token property">"address_locality"</span><span class="token operator">:</span> <span class="token string">"Edinburgh"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre>
<div class="callout callout--info">
<strong>Implementation needed?</strong> See the <a href="/sg-identity-techdocs/integration-examples/#phase-3-verified-attributes-examples">Verified Attributes Examples</a> for code implementation.
</div>
<h2 id="phase-4-production-deployment" tabindex="-1"><a class="header-anchor" href="#phase-4-production-deployment"><span>Phase 4: Production Deployment</span></a></h2>
<h3 id="environment-configuration" tabindex="-1"><a class="header-anchor" href="#environment-configuration"><span>Environment Configuration</span></a></h3>
<p>Update endpoints for production:</p>
<p><strong>Production Discovery Endpoint:</strong></p>
<pre><code>https://authz.scotaccount.service.gov.scot/.well-known/openid-configuration
</code></pre>
<p><strong>Production Attribute Endpoint:</strong></p>
<pre><code>https://issuer.main.scotaccount.service.gov.scot/attributes/values
</code></pre>
<div class="callout callout--info">
<strong>Implementation needed?</strong> See the <a href="/sg-identity-techdocs/integration-examples/#environment-configuration">Environment Configuration</a> example for code implementation.
</div>
<h3 id="monitoring-and-logging" tabindex="-1"><a class="header-anchor" href="#monitoring-and-logging"><span>Monitoring and Logging</span></a></h3>
<p>Implement comprehensive monitoring for authentication events and metrics.</p>
<div class="callout callout--info">
<strong>Implementation needed?</strong> See the <a href="/sg-identity-techdocs/integration-examples/#monitoring-and-logging">Monitoring and Logging</a> example for code implementation.
</div>
<h3 id="error-handling" tabindex="-1"><a class="header-anchor" href="#error-handling"><span>Error Handling</span></a></h3>
<p>Implement user-friendly error handling for various authentication scenarios.</p>
<div class="callout callout--info">
<strong>Implementation needed?</strong> See the <a href="/sg-identity-techdocs/integration-examples/#error-handling">Error Handling</a> example for code implementation.
</div>
<h3 id="security-checklist" tabindex="-1"><a class="header-anchor" href="#security-checklist"><span>Security Checklist</span></a></h3>
<p>Before going live, verify:</p>
<ul>
<li>[ ] <strong>Private keys</strong> stored securely in secrets manager</li>
<li>[ ] <strong>HTTPS only</strong> - no HTTP endpoints in production</li>
<li>[ ] <strong>State validation</strong> implemented for CSRF protection</li>
<li>[ ] <strong>Nonce validation</strong> prevents replay attacks</li>
<li>[ ] <strong>Token expiration</strong> handled correctly</li>
<li>[ ] <strong>Session management</strong> implemented securely</li>
<li>[ ] <strong>Error logging</strong> without exposing sensitive data</li>
<li>[ ] <strong>Rate limiting</strong> on authentication endpoints</li>
<li>[ ] <strong>Monitoring</strong> and alerting configured</li>
</ul>
<h2 id="complete-example-implementation" tabindex="-1"><a class="header-anchor" href="#complete-example-implementation"><span>Complete Example Implementation</span></a></h2>
<p>For a complete working example, see the comprehensive Node.js/Express implementation.</p>
<div class="callout callout--info">
<strong>Implementation needed?</strong> See the <a href="/sg-identity-techdocs/integration-examples/#complete-example-implementation">Complete Example Implementation</a> for a full working example.
</div>
<h2 id="troubleshooting-common-issues" tabindex="-1"><a class="header-anchor" href="#troubleshooting-common-issues"><span>Troubleshooting Common Issues</span></a></h2>
<h3 id="invalid-client-assertion" tabindex="-1"><a class="header-anchor" href="#invalid-client-assertion"><span>Invalid Client Assertion</span></a></h3>
<p><strong>Symptom</strong>: <code>invalid_client</code> error during token exchange<br>
<strong>Solution</strong>: Check JWT claims, expiration time, and private key format</p>
<h3 id="state-parameter-mismatch" tabindex="-1"><a class="header-anchor" href="#state-parameter-mismatch"><span>State Parameter Mismatch</span></a></h3>
<p><strong>Symptom</strong>: CSRF protection errors<br>
<strong>Solution</strong>: Ensure state is generated, stored, and validated correctly</p>
<h3 id="token-validation-failures" tabindex="-1"><a class="header-anchor" href="#token-validation-failures"><span>Token Validation Failures</span></a></h3>
<p><strong>Symptom</strong>: JWT verification errors<br>
<strong>Solution</strong>: Verify audience, issuer, and nonce claims match expected values</p>
<h3 id="pkce-errors" tabindex="-1"><a class="header-anchor" href="#pkce-errors"><span>PKCE Errors</span></a></h3>
<p><strong>Symptom</strong>: <code>invalid_grant</code> errors<br>
<strong>Solution</strong>: Ensure code verifier and challenge are generated and used correctly</p>
<h2 id="support-and-next-steps" tabindex="-1"><a class="header-anchor" href="#support-and-next-steps"><span>Support and Next Steps</span></a></h2>
<div class="callout callout--success">
<strong>Implementation complete?</strong> Review the <a href="/sg-identity-techdocs/scotaccount-token-validation-module/">Token Validation Module</a> for advanced security patterns.
</div>
<div class="callout callout--info">
<strong>Need architecture details?</strong> See the <a href="/sg-identity-techdocs/architecture/">Architecture Overview</a> for system components and data flows.
</div>
<div class="callout callout--warning">
<strong>Ready for production?</strong> Contact the ScotAccount team for production onboarding and security review.
</div>


      <!-- Last updated -->
      
      <footer class="content-footer">
        <p><small>Last updated: 19 August 2025</small></p>
      </footer>
      
    </main>
  </div>

  <!-- Site footer (Scottish Government Style) -->
  <footer class="sg-footer" role="contentinfo">
    <div class="sg-footer__container">
      <div class="sg-footer__content">
        <div class="sg-footer__section">
          <h3 class="sg-footer__heading">ScotAccount</h3>
            <ul class="sg-footer__links">
            <li><a href="/sg-identity-techdocs/" class="sg-footer__link">Documentation home</a></li>
            <li><a href="/sg-identity-techdocs/getting-started/" class="sg-footer__link">Getting started</a></li>
            <li><a href="/sg-identity-techdocs/scotaccount-complete-guide/" class="sg-footer__link">Complete guide</a></li>
            </ul>
        </div>
        
        <div class="sg-footer__section">
          <h3 class="sg-footer__heading">Scottish Government</h3>
          <ul class="sg-footer__links">
            <li><a href="https://www.gov.scot" target="_blank" rel="noopener" class="sg-footer__link">gov.scot</a></li>
            <li><a href="https://www.gov.scot/about/how-government-is-run/directorates/digital-directorate/" target="_blank" rel="noopener" class="sg-footer__link">Digital Directorate</a></li>
            <li><a href="https://www.gov.scot/publications/" target="_blank" rel="noopener" class="sg-footer__link">Publications</a></li>
          </ul>
        </div>
        
        <div class="sg-footer__section">
          <h3 class="sg-footer__heading">Help and support</h3>
          <ul class="sg-footer__links">
            <li><a href="https://www.gov.scot/about/contact-information/" target="_blank" rel="noopener" class="sg-footer__link">Contact us</a></li>
            <li><a href="https://www.gov.scot/accessibility/" target="_blank" rel="noopener" class="sg-footer__link">Accessibility</a></li>
            <li><a href="https://www.gov.scot/privacy/" target="_blank" rel="noopener" class="sg-footer__link">Privacy</a></li>
            <li><a href="https://www.gov.scot/cookies/" target="_blank" rel="noopener" class="sg-footer__link">Cookies</a></li>
          </ul>
        </div>
      </div>
      
      <div class="sg-footer__legal">
        <p class="sg-footer__copyright">&copy; Crown Copyright. All content is available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank" rel="noopener" class="sg-footer__link">Open Government Licence v3.0</a>, except where otherwise stated.</p>
        <p class="sg-footer__site">
          <a href="https://gov.scot" class="sg-footer__link">gov.scot</a>
        </p>
      </div>
    </div>
  </footer>

  <!-- JavaScript for table of contents generation -->
  <script>
    // Generate table of contents for better scannable structure
    document.addEventListener('DOMContentLoaded', function() {
      const headings = document.querySelectorAll('main h2, main h3, main h4');
      const tocContainer = document.querySelector('.sidebar__nav');
      const placeholder = document.getElementById('toc-placeholder');
      
      if (headings.length > 0 && tocContainer && placeholder) {
        // Remove placeholder
        placeholder.remove();
        
        // Generate TOC
        headings.forEach(function(heading, index) {
          // Add ID to heading if it doesn't have one
          if (!heading.id) {
            heading.id = 'heading-' + index;
          }
          
          // Create TOC item
          const li = document.createElement('li');
          li.className = 'sidebar__nav-item';
          
          const a = document.createElement('a');
          a.href = '#' + heading.id;
          a.className = 'sidebar__nav-link';
          a.textContent = heading.textContent;
          
          // Add visual hierarchy for different heading levels
          if (heading.tagName === 'H3') {
            a.style.paddingLeft = '2rem';
          } else if (heading.tagName === 'H4') {
            a.style.paddingLeft = '3rem';
          }
          
          li.appendChild(a);
          tocContainer.appendChild(li);
        });
      } else if (placeholder) {
        placeholder.textContent = 'No headings found';
      }
      
      // Smooth scroll for anchor links
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            target.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        });
      });
    });

    // Cookie banner functionality (Scottish Government style)
    function acceptAllCookies() {
      localStorage.setItem('cookiePreference', 'all');
      hideCookieBanner();
    }

    function useEssentialCookies() {
      localStorage.setItem('cookiePreference', 'essential');
      hideCookieBanner();
    }

    function setCookiePreferences() {
      // In a real implementation, this would open a preferences modal
      localStorage.setItem('cookiePreference', 'essential');
      hideCookieBanner();
      alert('Cookie preferences saved. Only essential cookies will be used.');
    }

    function hideCookieBanner() {
      const banner = document.getElementById('cookie-banner');
      if (banner) {
        banner.style.display = 'none';
      }
    }

    // Check if user has already made a cookie preference
    document.addEventListener('DOMContentLoaded', function() {
      const cookiePreference = localStorage.getItem('cookiePreference');
      if (cookiePreference) {
        hideCookieBanner();
      }
    });

    // Mobile navigation toggle
    document.addEventListener('DOMContentLoaded', function() {
      const navToggle = document.querySelector('.sg-nav__toggle');
      const navMenu = document.querySelector('.sg-nav__list');
      
      if (navToggle && navMenu) {
        navToggle.addEventListener('click', function() {
          const isExpanded = navToggle.getAttribute('aria-expanded') === 'true';
          navToggle.setAttribute('aria-expanded', !isExpanded);
          navMenu.classList.toggle('sg-nav__list--open');
        });
      }
    });
  </script>

  <!-- Search functionality -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
  <script src="/sg-identity-techdocs/js/search.js"></script>
</body>
</html>
