<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  
  
  
  

  <title>Integration Examples and Best Practices | ScotAccount Technical Documentation</title>
  <meta name="description" content="Practical integration examples and solutions for ScotAccount implementation challenges">

  
  <link rel="canonical" href="https://scotaccount.github.io/sg-identity-techdocs/integration-examples/">

  
  <link rel="icon" type="image/x-icon" href="/sg-identity-techdocs/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/sg-identity-techdocs/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/sg-identity-techdocs/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/sg-identity-techdocs/favicon-16x16.png">
  <link rel="mask-icon" href="/sg-identity-techdocs/safari-pinned-tab.svg" color="#0065bd">

  
  <link rel="stylesheet" href="/sg-identity-techdocs/css/main.css">

  
  <meta property="og:title" content="Integration Examples and Best Practices">
  <meta property="og:description" content="Practical integration examples and solutions for ScotAccount implementation challenges">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://scotaccount.github.io/sg-identity-techdocs/integration-examples/">
  <meta property="og:image" content="https://scotaccount.github.io/sg-identity-techdocs/apple-touch-icon.png">

  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "TechArticle",
    "headline": "Integration Examples and Best Practices",
    "description": "Practical integration examples and solutions for ScotAccount implementation challenges",
    "url": "https://scotaccount.github.io/sg-identity-techdocs/integration-examples/",
    "image": "https://scotaccount.github.io/sg-identity-techdocs/apple-touch-icon.png",
    "author": {
      "@type": "Organization",
      "name": "Scottish Government",
      "url": "https://www.gov.scot"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Scottish Government",
      "url": "https://www.gov.scot"
    }
  }
  </script>
</head>

<body>
  <!-- Cookie banner and skip link as you had, if needed -->

  <header class="sg-header" role="banner">
    <div class="sg-header__wrapper">
      <div class="sg-header__branding">
        <a href="/sg-identity-techdocs/" class="sg-header__logo">
          <img src="/sg-identity-techdocs/assets/scotgovlogo.svg" alt="Scottish Government">
        </a>
      </div>
      <div class="sg-header__search">
        <form class="sg-header__search-form" role="search" action="/sg-identity-techdocs/search" method="get">
          <label for="search-input" class="sg-header__search-label">Search</label>
          <input type="search" id="search-input" name="q" class="sg-header__search-input" placeholder="Search">
          <button type="submit" class="sg-header__search-button">Search</button>
        </form>
      </div>
    </div>
  </header>

  
  <nav class="site-nav" role="navigation" aria-label="Main navigation">
    <div class="site-nav__wrapper">
      <ul class="site-nav__list" id="nav-menu">
        
          
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/" class="site-nav__link">
              Home
            </a>
          </li>
        
          
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/getting-started/" class="site-nav__link">
              Getting Started
            </a>
          </li>
        
          
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/architecture/" class="site-nav__link">
              Architecture
            </a>
          </li>
        
          
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/scotaccount-guide/" class="site-nav__link">
              Implementation Guide
            </a>
          </li>
        
          
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/scotaccount-complete-guide/" class="site-nav__link">
              Comprehensive Guide
            </a>
          </li>
        
          
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/scotaccount-token-validation-module/" class="site-nav__link">
              Token Validation
            </a>
          </li>
        
      </ul>
    </div>
  </nav>

  <div class="container">
    
    
    <aside class="sidebar" role="complementary" aria-label="Page navigation">
      <h2 class="sidebar__title">On this page</h2>
      <nav class="sidebar__nav" aria-label="Page contents">
        <ul class="sidebar__nav">
          <li class="sidebar__nav-item">
            <a href="#" class="sidebar__nav-link" id="toc-placeholder">Contents loading...</a>
          </li>
        </ul>
      </nav>

      <hr style="margin:1.5rem 0;border:none;border-top:1px solid var(--sg-border-grey);">
      <h3 class="sidebar__title">All pages</h3>
      <ul class="sidebar__nav">
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/architecture/" class="sidebar__nav-link">
              ScotAccount Architecture Overview
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/getting-started/" class="sidebar__nav-link">
              Getting Started with ScotAccount
            </a>
          </li>
          
        
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/integration-examples/" class="sidebar__nav-link sidebar__nav-link--active">
              Integration Examples and Best Practices
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/scotaccount-complete-guide/" class="sidebar__nav-link">
              Comprehensive Guide
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/scotaccount-guide/" class="sidebar__nav-link">
              Implementation Guide
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/scotaccount-modular-structure/" class="sidebar__nav-link">
              ScotAccount Modular Structure
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/scotaccount-token-validation-module/" class="sidebar__nav-link">
              Token Validation Module
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/search/" class="sidebar__nav-link">
              Search results
            </a>
          </li>
          
        
      </ul>
    </aside>
    

    <main class="main" id="main-content" role="main" tabindex="-1">
      <h1>Integration Examples and Best Practices</h1>
      <p class="lead">Practical integration examples and solutions for ScotAccount implementation challenges</p>

      <p>This page provides practical integration examples and best practices for ScotAccount, helping you implement secure, robust code that you can tailor for your needs. These code elements are for example purposes only</p>
<h2 id="phase-1-setup-registration-examples" tabindex="-1"><a class="header-anchor" href="#phase-1-setup-registration-examples"><span>Phase 1: Setup &amp; Registration Examples</span></a></h2>
<h3 id="discovery-endpoint-integration" tabindex="-1"><a class="header-anchor" href="#discovery-endpoint-integration"><span>Discovery Endpoint Integration</span></a></h3>
<p>Always retrieve current configuration dynamically:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getOidcConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>
    <span class="token string">"https://authz.integration.scotaccount.service.gov.scot/.well-known/openid-configuration"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>Key configuration values</strong>:</p>
<ul>
<li><code>authorization_endpoint</code> - Where to send authentication requests</li>
<li><code>token_endpoint</code> - Where to exchange codes for tokens</li>
<li><code>jwks_uri</code> - Public keys for token validation</li>
</ul>
<h3 id="pkce-implementation" tabindex="-1"><a class="header-anchor" href="#pkce-implementation"><span>PKCE Implementation</span></a></h3>
<p>Generate PKCE parameters for security:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">generatePKCE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Generate random code verifier</span>
  <span class="token keyword">const</span> codeVerifier <span class="token operator">=</span> <span class="token function">base64URLEncode</span><span class="token punctuation">(</span>crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Create SHA256 hash</span>
  <span class="token keyword">const</span> hash <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">"sha256"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>codeVerifier<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> codeChallenge <span class="token operator">=</span> <span class="token function">base64URLEncode</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    codeVerifier<span class="token punctuation">,</span>
    codeChallenge<span class="token punctuation">,</span>
    <span class="token literal-property property">codeChallengeMethod</span><span class="token operator">:</span> <span class="token string">"S256"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="phase-2-basic-authentication-examples" tabindex="-1"><a class="header-anchor" href="#phase-2-basic-authentication-examples"><span>Phase 2: Basic Authentication Examples</span></a></h2>
<h3 id="authorization-request-builder" tabindex="-1"><a class="header-anchor" href="#authorization-request-builder"><span>Authorization Request Builder</span></a></h3>
<p>Build the authentication URL:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">buildAuthUrl</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> pkce<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> redirectUri</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> nonce <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">client_id</span><span class="token operator">:</span> clientId<span class="token punctuation">,</span>
    <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> redirectUri<span class="token punctuation">,</span>
    <span class="token literal-property property">response_type</span><span class="token operator">:</span> <span class="token string">"code"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">"openid"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> state<span class="token punctuation">,</span>
    <span class="token literal-property property">nonce</span><span class="token operator">:</span> nonce<span class="token punctuation">,</span>
    <span class="token literal-property property">code_challenge</span><span class="token operator">:</span> pkce<span class="token punctuation">.</span>codeChallenge<span class="token punctuation">,</span>
    <span class="token literal-property property">code_challenge_method</span><span class="token operator">:</span> pkce<span class="token punctuation">.</span>codeChallengeMethod<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Store state and nonce for validation</span>
  <span class="token function">storeSecurely</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> nonce<span class="token punctuation">,</span> <span class="token literal-property property">codeVerifier</span><span class="token operator">:</span> pkce<span class="token punctuation">.</span>codeVerifier <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>authorization_endpoint<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="callback-handler" tabindex="-1"><a class="header-anchor" href="#callback-handler"><span>Callback Handler</span></a></h3>
<p>Process the authentication response:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> state<span class="token punctuation">,</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>

  <span class="token comment">// Handle errors first</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Authentication failed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Validate state parameter</span>
  <span class="token keyword">const</span> storedData <span class="token operator">=</span> <span class="token function">retrieveSecurely</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>storedData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Invalid state parameter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">,</span>
    state<span class="token punctuation">,</span>
    <span class="token literal-property property">nonce</span><span class="token operator">:</span> storedData<span class="token punctuation">.</span>nonce<span class="token punctuation">,</span>
    <span class="token literal-property property">codeVerifier</span><span class="token operator">:</span> storedData<span class="token punctuation">.</span>codeVerifier<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="jwt-client-assertion" tabindex="-1"><a class="header-anchor" href="#jwt-client-assertion"><span>JWT Client Assertion</span></a></h3>
<p>Create signed JWT for token exchange:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createClientAssertion</span><span class="token punctuation">(</span><span class="token parameter">clientId<span class="token punctuation">,</span> tokenEndpoint<span class="token punctuation">,</span> privateKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">iss</span><span class="token operator">:</span> clientId<span class="token punctuation">,</span>
    <span class="token literal-property property">sub</span><span class="token operator">:</span> clientId<span class="token punctuation">,</span>
    <span class="token literal-property property">aud</span><span class="token operator">:</span> tokenEndpoint<span class="token punctuation">,</span>
    <span class="token literal-property property">exp</span><span class="token operator">:</span> now <span class="token operator">+</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token comment">// 6 months expiration</span>
    <span class="token literal-property property">iat</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
    <span class="token literal-property property">jti</span><span class="token operator">:</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> privateKey<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">algorithm</span><span class="token operator">:</span> <span class="token string">"RS256"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="token-exchange" tabindex="-1"><a class="header-anchor" href="#token-exchange"><span>Token Exchange</span></a></h3>
<p>Exchange authorization code for tokens:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">exchangeCodeForTokens</span><span class="token punctuation">(</span>
  <span class="token parameter">config<span class="token punctuation">,</span>
  code<span class="token punctuation">,</span>
  redirectUri<span class="token punctuation">,</span>
  codeVerifier<span class="token punctuation">,</span>
  clientAssertion</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>token_endpoint<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">grant_type</span><span class="token operator">:</span> <span class="token string">"authorization_code"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">code</span><span class="token operator">:</span> code<span class="token punctuation">,</span>
      <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> redirectUri<span class="token punctuation">,</span>
      <span class="token literal-property property">client_assertion_type</span><span class="token operator">:</span>
        <span class="token string">"urn:ietf:params:oauth:client-assertion-type:jwt-bearer"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">client_assertion</span><span class="token operator">:</span> clientAssertion<span class="token punctuation">,</span>
      <span class="token literal-property property">code_verifier</span><span class="token operator">:</span> codeVerifier<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Token exchange failed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>response<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="id-token-validation" tabindex="-1"><a class="header-anchor" href="#id-token-validation"><span>ID Token Validation</span></a></h3>
<p>Validate and extract user information:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">validateIdToken</span><span class="token punctuation">(</span><span class="token parameter">idToken<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> config<span class="token punctuation">,</span> expectedNonce</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Get public keys</span>
  <span class="token keyword">const</span> jwks <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>jwks_uri<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Verify JWT signature and claims</span>
  <span class="token keyword">const</span> decoded <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>idToken<span class="token punctuation">,</span> <span class="token function">getPublicKey</span><span class="token punctuation">(</span>jwks<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">algorithms</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"RS256"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">audience</span><span class="token operator">:</span> clientId<span class="token punctuation">,</span>
    <span class="token literal-property property">issuer</span><span class="token operator">:</span> config<span class="token punctuation">.</span>issuer<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Validate nonce</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>decoded<span class="token punctuation">.</span>nonce <span class="token operator">!==</span> expectedNonce<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Invalid nonce"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">userId</span><span class="token operator">:</span> decoded<span class="token punctuation">.</span>sub<span class="token punctuation">,</span>
    <span class="token literal-property property">sessionId</span><span class="token operator">:</span> decoded<span class="token punctuation">.</span>sid<span class="token punctuation">,</span>
    <span class="token literal-property property">authenticatedAt</span><span class="token operator">:</span> decoded<span class="token punctuation">.</span>iat<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="phase-3-verified-attributes-examples" tabindex="-1"><a class="header-anchor" href="#phase-3-verified-attributes-examples"><span>Phase 3: Verified Attributes Examples</span></a></h2>
<h3 id="attribute-request-implementation" tabindex="-1"><a class="header-anchor" href="#attribute-request-implementation"><span>Attribute Request Implementation</span></a></h3>
<p>Request verified attributes using access token:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">requestVerifiedAttributes</span><span class="token punctuation">(</span><span class="token parameter">accessToken<span class="token punctuation">,</span> clientAssertion</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>
    <span class="token string">"https://issuer.main.integration.scotaccount.service.gov.scot/attributes/values"</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">Authorization</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>accessToken<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token string-property property">"DIS-Client-Assertion"</span><span class="token operator">:</span> clientAssertion<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Attribute request failed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>response<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="attribute-token-validation" tabindex="-1"><a class="header-anchor" href="#attribute-token-validation"><span>Attribute Token Validation</span></a></h3>
<p>Validate and extract verified claims:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">validateAttributeToken</span><span class="token punctuation">(</span><span class="token parameter">claimsToken<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Get public keys for attribute service</span>
  <span class="token keyword">const</span> jwks <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>attribute_jwks_uri<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Verify JWT signature and claims</span>
  <span class="token keyword">const</span> decoded <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>claimsToken<span class="token punctuation">,</span> <span class="token function">getPublicKey</span><span class="token punctuation">(</span>jwks<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">algorithms</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"RS256"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">issuer</span><span class="token operator">:</span> config<span class="token punctuation">.</span>attribute_issuer<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> decoded<span class="token punctuation">.</span>verified_claims<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="phase-4-production-deployment-examples" tabindex="-1"><a class="header-anchor" href="#phase-4-production-deployment-examples"><span>Phase 4: Production Deployment Examples</span></a></h2>
<h3 id="environment-configuration" tabindex="-1"><a class="header-anchor" href="#environment-configuration"><span>Environment Configuration</span></a></h3>
<p>Update endpoints for production:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">integration</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">discoveryUrl</span><span class="token operator">:</span>
      <span class="token string">"https://authz.integration.scotaccount.service.gov.scot/.well-known/openid-configuration"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">production</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">discoveryUrl</span><span class="token operator">:</span>
      <span class="token string">"https://authz.scotaccount.service.gov.scot/.well-known/openid-configuration"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h3 id="monitoring-and-logging" tabindex="-1"><a class="header-anchor" href="#monitoring-and-logging"><span>Monitoring and Logging</span></a></h3>
<p>Implement comprehensive monitoring:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Log authentication events</span>
<span class="token keyword">function</span> <span class="token function">logAuthEvent</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> details</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">timestamp</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">event</span><span class="token operator">:</span> event<span class="token punctuation">,</span>
      <span class="token literal-property property">userId</span><span class="token operator">:</span> userId<span class="token punctuation">,</span>
      <span class="token literal-property property">sessionId</span><span class="token operator">:</span> details<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span>
      <span class="token literal-property property">userAgent</span><span class="token operator">:</span> details<span class="token punctuation">.</span>userAgent<span class="token punctuation">,</span>
      <span class="token literal-property property">ipAddress</span><span class="token operator">:</span> details<span class="token punctuation">.</span>ipAddress<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Track authentication metrics</span>
<span class="token keyword">function</span> <span class="token function">trackMetrics</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> duration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Send to your monitoring system</span>
  metrics<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">scotaccount.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  metrics<span class="token punctuation">.</span><span class="token function">timing</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">scotaccount.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.duration</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="error-handling" tabindex="-1"><a class="header-anchor" href="#error-handling"><span>Error Handling</span></a></h3>
<p>Implement user-friendly error handling:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">handleAuthError</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Authentication error:"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">"access_denied"</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"/auth/cancelled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">"invalid_request"</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Invalid authentication request"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Authentication service temporarily unavailable"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="complete-example-implementation" tabindex="-1"><a class="header-anchor" href="#complete-example-implementation"><span>Complete Example Implementation</span></a></h2>
<p>Hereâ€™s a complete Node.js/Express example:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"jsonwebtoken"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"crypto"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Configuration</span>
<span class="token keyword">const</span> <span class="token constant">CLIENT_ID</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SCOTACCOUNT_CLIENT_ID</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PRIVATE_KEY</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SCOTACCOUNT_PRIVATE_KEY</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REDIRECT_URI</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SCOTACCOUNT_REDIRECT_URI</span><span class="token punctuation">;</span>

<span class="token comment">// Routes</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/auth/login"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getOidcConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> pkce <span class="token operator">=</span> <span class="token function">generatePKCE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> authUrl <span class="token operator">=</span> <span class="token function">buildAuthUrl</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> pkce<span class="token punctuation">,</span> <span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span> <span class="token constant">REDIRECT_URI</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>authUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleAuthError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/auth/callback"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> callbackData <span class="token operator">=</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getOidcConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> clientAssertion <span class="token operator">=</span> <span class="token function">createClientAssertion</span><span class="token punctuation">(</span>
      <span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span>
      config<span class="token punctuation">.</span>token_endpoint<span class="token punctuation">,</span>
      <span class="token constant">PRIVATE_KEY</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exchangeCodeForTokens</span><span class="token punctuation">(</span>
      config<span class="token punctuation">,</span>
      callbackData<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
      <span class="token constant">REDIRECT_URI</span><span class="token punctuation">,</span>
      callbackData<span class="token punctuation">.</span>codeVerifier<span class="token punctuation">,</span>
      clientAssertion
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">validateIdToken</span><span class="token punctuation">(</span>
      tokens<span class="token punctuation">.</span>id_token<span class="token punctuation">,</span>
      <span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span>
      config<span class="token punctuation">,</span>
      callbackData<span class="token punctuation">.</span>nonce
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store user session</span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user <span class="token operator">=</span> userInfo<span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"/dashboard"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleAuthError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Server running on port 3000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="example-complete-authentication-flow" tabindex="-1"><a class="header-anchor" href="#example-complete-authentication-flow"><span>Example: Complete Authentication Flow</span></a></h2>
<p><strong>Implementing PKCE (Proof Key for Code Exchange):</strong></p>
<ul>
<li><strong>Why:</strong> Enhances security by preventing interception attacks</li>
<li><strong>How:</strong> Always implement PKCE with the SHA256 method as shown below</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Complete authentication flow with PKCE and error handling</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleAuthentication</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// Generate secure parameters</span>
    <span class="token keyword">const</span> pkce <span class="token operator">=</span> <span class="token function">generatePKCE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">generateSecureState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nonce <span class="token operator">=</span> <span class="token function">generateNonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store securely for validation</span>
    <span class="token keyword">await</span> <span class="token function">storeAuthState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> nonce<span class="token punctuation">,</span> <span class="token literal-property property">codeVerifier</span><span class="token operator">:</span> pkce<span class="token punctuation">.</span>codeVerifier <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Build authorisation URL</span>
    <span class="token keyword">const</span> authUrl <span class="token operator">=</span> <span class="token function">buildAuthorisationUrl</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">clientId</span><span class="token operator">:</span> <span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span>
      <span class="token literal-property property">redirectUri</span><span class="token operator">:</span> <span class="token constant">REDIRECT_URI</span><span class="token punctuation">,</span>
      <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">"openid"</span><span class="token punctuation">,</span>
      state<span class="token punctuation">,</span>
      nonce<span class="token punctuation">,</span>
      <span class="token literal-property property">codeChallenge</span><span class="token operator">:</span> pkce<span class="token punctuation">.</span>codeChallenge<span class="token punctuation">,</span>
      <span class="token literal-property property">codeChallengeMethod</span><span class="token operator">:</span> <span class="token string">"S256"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>authUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleAuthError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="example-token-validation" tabindex="-1"><a class="header-anchor" href="#example-token-validation"><span>Example: Token Validation</span></a></h2>
<p><strong>Verifying ID Tokens:</strong></p>
<ul>
<li><strong>Why:</strong> Ensures tokens are valid and not tampered with</li>
<li><strong>How:</strong> Always validate tokens as shown below</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Token validation example</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">validateTokens</span><span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> expectedState<span class="token punctuation">,</span> expectedNonce</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Validate state first</span>
  <span class="token keyword">const</span> storedAuth <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getAuthState</span><span class="token punctuation">(</span>expectedState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>storedAuth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Invalid state - possible CSRF attack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Validate ID token</span>
  <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">validateIdToken</span><span class="token punctuation">(</span>
    tokens<span class="token punctuation">.</span>id_token<span class="token punctuation">,</span>
    <span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span>
    expectedNonce<span class="token punctuation">,</span>
    <span class="token constant">ISSUER</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Extract and validate claims</span>
  <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token function">extractUserInfo</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Clean up stored state</span>
  <span class="token keyword">await</span> <span class="token function">deleteAuthState</span><span class="token punctuation">(</span>expectedState<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> userInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="example-secure-session-management" tabindex="-1"><a class="header-anchor" href="#example-secure-session-management"><span>Example: Secure Session Management</span></a></h2>
<p><strong>Storing Sessions Securely:</strong></p>
<ul>
<li><strong>Why:</strong> Protects user data and prevents unauthorised access</li>
<li><strong>How:</strong> Use encrypted, server-side session storage</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Secure session implementation example</span>
<span class="token keyword">class</span> <span class="token class-name">SecureSession</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">sessionData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>userId <span class="token operator">=</span> sessionData<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sessionId <span class="token operator">=</span> sessionData<span class="token punctuation">.</span>sessionId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>createdAt <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lastActivity <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>expiresAt <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// 1 hour</span>
  <span class="token punctuation">}</span>

  <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expiresAt<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">updateActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lastActivity <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">store</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> encrypted <span class="token operator">=</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">setex</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">session:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token number">28800</span><span class="token punctuation">,</span> encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">retrieve</span><span class="token punctuation">(</span><span class="token parameter">sessionId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> encrypted <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">session:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sessionId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>encrypted<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureSession</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>session<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> session<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> redis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">session:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>sessionId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="example-multi-environment-configuration" tabindex="-1"><a class="header-anchor" href="#example-multi-environment-configuration"><span>Example: Multi-Environment Configuration</span></a></h2>
<p><strong>Configuring for Different Environments:</strong></p>
<ul>
<li><strong>Why:</strong> Ensures correct settings for development, integration, and production</li>
<li><strong>How:</strong> Use environment-specific configuration as shown below</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Environment-specific configuration example</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">development</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">discoveryUrl</span><span class="token operator">:</span>
      <span class="token string">"https://authz.integration.scotaccount.service.gov.scot/.well-known/openid-configuration"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">clientId</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DEV_CLIENT_ID</span><span class="token punctuation">,</span>
    <span class="token literal-property property">redirectUri</span><span class="token operator">:</span> <span class="token string">"http://localhost:3000/auth/callback"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token literal-property property">integration</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">discoveryUrl</span><span class="token operator">:</span>
      <span class="token string">"https://authz.integration.scotaccount.service.gov.scot/.well-known/openid-configuration"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">clientId</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">INT_CLIENT_ID</span><span class="token punctuation">,</span>
    <span class="token literal-property property">redirectUri</span><span class="token operator">:</span> <span class="token string">"https://your-service-int.gov.scot/auth/callback"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token literal-property property">production</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">discoveryUrl</span><span class="token operator">:</span>
      <span class="token string">"https://authz.scotaccount.service.gov.scot/.well-known/openid-configuration"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">clientId</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROD_CLIENT_ID</span><span class="token punctuation">,</span>
    <span class="token literal-property property">redirectUri</span><span class="token operator">:</span> <span class="token string">"https://your-service.gov.scot/auth/callback"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> currentConfig <span class="token operator">=</span> config<span class="token punctuation">[</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">"development"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<h2 id="example-error-handling" tabindex="-1"><a class="header-anchor" href="#example-error-handling"><span>Example: Error Handling</span></a></h2>
<p><strong>Handling Authentication Errors:</strong></p>
<ul>
<li><strong>Why:</strong> Improves user experience and simplifies debugging</li>
<li><strong>How:</strong> Implement detailed error handling for different scenarios</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Error handling example</span>
<span class="token keyword">function</span> <span class="token function">handleAuthError</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> errorCode <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>error<span class="token punctuation">;</span>
  <span class="token keyword">const</span> errorDescription <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>error_description<span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">"access_denied"</span><span class="token operator">:</span>
      <span class="token comment">// User cancelled authentication</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"auth-cancelled"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Authentication was cancelled. Please try again."</span><span class="token punctuation">,</span>
        <span class="token literal-property property">retryUrl</span><span class="token operator">:</span> <span class="token string">"/auth/login"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> <span class="token string">"invalid_request"</span><span class="token operator">:</span>
      <span class="token comment">// Malformed request</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Invalid auth request:"</span><span class="token punctuation">,</span> errorDescription<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Invalid authentication request. Please contact support."</span><span class="token punctuation">,</span>
        <span class="token literal-property property">supportEmail</span><span class="token operator">:</span> <span class="token string">"support@your-service.gov.scot"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> <span class="token string">"server_error"</span><span class="token operator">:</span>
      <span class="token comment">// ScotAccount service error</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"ScotAccount service error:"</span><span class="token punctuation">,</span> errorDescription<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">502</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span>
          <span class="token string">"Authentication service temporarily unavailable. Please try again later."</span><span class="token punctuation">,</span>
        <span class="token literal-property property">retryUrl</span><span class="token operator">:</span> <span class="token string">"/auth/login"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token comment">// Unexpected error</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Unexpected auth error:"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"An unexpected error occurred. Please try again."</span><span class="token punctuation">,</span>
        <span class="token literal-property property">retryUrl</span><span class="token operator">:</span> <span class="token string">"/auth/login"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="example-monitoring-and-logging" tabindex="-1"><a class="header-anchor" href="#example-monitoring-and-logging"><span>Example: Monitoring and Logging</span></a></h2>
<p><strong>Tracking Authentication Events:</strong></p>
<ul>
<li><strong>Why:</strong> Enables auditing and monitoring of authentication flows</li>
<li><strong>How:</strong> Log events and metrics as shown below</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Monitoring and logging example</span>
<span class="token keyword">class</span> <span class="token class-name">AuthMonitoring</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">logAuthEvent</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> details <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> logEntry <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">timestamp</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">event</span><span class="token operator">:</span> event<span class="token punctuation">,</span>
      <span class="token literal-property property">userId</span><span class="token operator">:</span> userId<span class="token punctuation">,</span>
      <span class="token literal-property property">sessionId</span><span class="token operator">:</span> details<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span>
      <span class="token literal-property property">userAgent</span><span class="token operator">:</span> details<span class="token punctuation">.</span>userAgent<span class="token punctuation">,</span>
      <span class="token literal-property property">ipAddress</span><span class="token operator">:</span> details<span class="token punctuation">.</span>ipAddress<span class="token punctuation">,</span>
      <span class="token literal-property property">environment</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>logEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Send to monitoring service</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendToMonitoring</span><span class="token punctuation">(</span>logEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">trackMetric</span><span class="token punctuation">(</span><span class="token parameter">metric<span class="token punctuation">,</span> value<span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Send metrics to monitoring system</span>
    metrics<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">scotaccount.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>metric<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">sendToMonitoring</span><span class="token punctuation">(</span><span class="token parameter">logEntry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MONITORING_ENDPOINT</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>logEntry<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to send monitoring data:"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Usage examples</span>
AuthMonitoring<span class="token punctuation">.</span><span class="token function">logAuthEvent</span><span class="token punctuation">(</span><span class="token string">"auth_started"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">userAgent</span><span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"User-Agent"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AuthMonitoring<span class="token punctuation">.</span><span class="token function">logAuthEvent</span><span class="token punctuation">(</span><span class="token string">"auth_success"</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">sessionId</span><span class="token operator">:</span> userInfo<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AuthMonitoring<span class="token punctuation">.</span><span class="token function">trackMetric</span><span class="token punctuation">(</span><span class="token string">"auth_duration"</span><span class="token punctuation">,</span> authDuration<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="example-integration-and-security-testing" tabindex="-1"><a class="header-anchor" href="#example-integration-and-security-testing"><span>Example: Integration and Security Testing</span></a></h2>
<p><strong>Testing Authentication and Security:</strong></p>
<ul>
<li><strong>Why:</strong> Ensures your integration is robust and secure</li>
<li><strong>How:</strong> Use integration and security tests as shown below</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Integration test example</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"ScotAccount Integration"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should complete full authentication flow"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// Start authentication</span>
    <span class="token keyword">const</span> authResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/auth/login"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Extract state and code challenge</span>
    <span class="token keyword">const</span> redirectUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>authResponse<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> redirectUrl<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Simulate callback with mock authorisation code</span>
    <span class="token keyword">const</span> callbackResponse <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/auth/callback"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token string">"mock_auth_code"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">state</span><span class="token operator">:</span> state<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Verify successful authentication</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>callbackResponse<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">"/dashboard"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Security test example</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"Security Tests"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should reject invalid state parameter"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/auth/callback"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token string">"valid_code"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">"invalid_state"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should reject expired tokens"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> expiredToken <span class="token operator">=</span> <span class="token function">createExpiredToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/api/user"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"Authorisation"</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expiredToken<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="production-readiness-checklist" tabindex="-1"><a class="header-anchor" href="#production-readiness-checklist"><span>Production Readiness Checklist</span></a></h2>
<ul>
<li>
<p>[ ] <strong>HTTPS enforcement</strong> in all environments</p>
</li>
<li>
<p>[ ] <strong>Security headers</strong> implementation</p>
</li>
<li>
<p>[ ] <strong>Rate limiting</strong> on authentication endpoints</p>
</li>
<li>
<p>[ ] <strong>CORS configuration</strong> for allowed origins</p>
</li>
<li>
<p>[ ] <strong>CSP headers</strong> for XSS protection</p>
</li>
<li>
<p>[ ] <strong>Secure cookie settings</strong> for session management</p>
</li>
<li>
<p>[ ] <strong>Environment variable validation</strong> on startup</p>
</li>
<li>
<p>[ ] <strong>Health check endpoints</strong> for monitoring</p>
</li>
<li>
<p>[ ] <strong>Graceful shutdown</strong> handling</p>
</li>
<li>
<p>[ ] <strong>Database connection pooling</strong> configuration</p>
</li>
<li>
<p>[ ] <strong>Performance optimisations</strong> (e.g., JWT key caching, connection pooling, request timeouts)</p>
</li>
</ul>
<h2 id="next-steps" tabindex="-1"><a class="header-anchor" href="#next-steps"><span>Next Steps</span></a></h2>
<div class="callout callout--success">
<strong>Ready to integrate?</strong> Use these examples and best practices to build a secure, robust ScotAccount integration.
</div>
<div class="callout callout--info">
<strong>Need more help?</strong> Follow the <a href="/sg-identity-techdocs/scotaccount-complete-guide/">Complete Implementation Guide</a> for comprehensive solutions.
</div>
<div class="callout callout--info">
<strong>Questions about security?</strong> Review the <a href="/sg-identity-techdocs/scotaccount-token-validation-module/">Token Validation Module</a> for detailed security guidance.
</div>


      
      <footer class="content-footer"><p><small>Last updated: 22 August 2025</small></p></footer>
      
    </main>
  </div>

  <footer class="sg-footer" role="contentinfo">
    <!-- your footer blocks as before -->
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
  <script src="/sg-identity-techdocs/js/search.js"></script>
</body>
</html>
