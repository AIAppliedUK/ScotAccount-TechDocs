<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Implementation Guide | ScotAccount Technical Documentation</title>
  <meta name="description" content="Comprehensive technical guide for implementing ScotAccount authentication and verified attributes">
  <link rel="canonical" href="https://scotaccount.github.io/sg-identity-techdocs/scotaccount-complete-guide/">
  
  <!-- Scottish Government favicons -->
  <link rel="icon" type="image/x-icon" href="/sg-identity-techdocs/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/sg-identity-techdocs/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/sg-identity-techdocs/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/sg-identity-techdocs/favicon-16x16.png">
  <link rel="mask-icon" href="/sg-identity-techdocs/safari-pinned-tab.svg" color="#0065bd">

  <!-- Styles -->
  <link rel="stylesheet" href="/sg-identity-techdocs/css/main.css">
  
  <!-- Open Graph -->
  <meta property="og:title" content="Complete Implementation Guide">
  <meta property="og:description" content="Comprehensive technical guide for implementing ScotAccount authentication and verified attributes">
  <meta property="og:type" content="website">
  <meta property="og:url" content="/scotaccount-complete-guide/">
  <meta property="og:image" content="apple-touch-icon.png">
  
  <!-- Schema.org -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "TechArticle",
    "headline": "Complete Implementation Guide",
    "description": "Comprehensive technical guide for implementing ScotAccount authentication and verified attributes",
    "author": {
      "@type": "Organization",
      "name": "Scottish Government",
      "url": "https://www.gov.scot"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Scottish Government",
      "url": "https://www.gov.scot"
    }
  }
  </script>
</head>
<body>
  <!-- Cookie Banner (Scottish Government Style) -->
  <div class="cookie-banner" id="cookie-banner" role="region" aria-labelledby="cookie-banner-heading">
    <div class="cookie-banner__container">
      <div class="cookie-banner__content">
        <h2 id="cookie-banner-heading" class="cookie-banner__heading">Information</h2>
        <p class="cookie-banner__text">We use <a href="#cookies" class="cookie-banner__link">cookies</a> to collect anonymous data to help us improve your site browsing experience.</p>
        <p class="cookie-banner__text">Click 'Accept all cookies' to agree to all cookies that collect anonymous data. To only allow the cookies that make the site work, click 'Use essential cookies only.' Visit 'Set cookie preferences' to control specific cookies.</p>
      </div>
      <div class="cookie-banner__actions">
        <button type="button" class="cookie-banner__button cookie-banner__button--primary" onclick="acceptAllCookies()">Accept all cookies</button>
        <button type="button" class="cookie-banner__button cookie-banner__button--secondary" onclick="useEssentialCookies()">Use essential cookies only</button>
        <button type="button" class="cookie-banner__button cookie-banner__button--link" onclick="setCookiePreferences()">Set cookie preferences</button>
      </div>
    </div>
  </div>

  <!-- Skip to main content for accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Scottish Government Identity Header (blue) -->
  <header class="sg-header" role="banner">
    <div class="sg-header__wrapper">
      <div class="sg-header__branding">
        <a href="/sg-identity-techdocs/" class="sg-header__logo">
          <img src="/sg-identity-techdocs/assets/scotgovlogo.svg" alt="Scottish Government">
        </a>
      </div>
      <div class="sg-header__search">
        <form class="sg-header__search-form" role="search" action="/sg-identity-techdocs/search" method="get">
          <label for="search-input" class="sg-header__search-label">Search</label>
          <input type="search" id="search-input" name="q" class="sg-header__search-input" placeholder="Search">
          <button type="submit" class="sg-header__search-button">
            <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
              <path fill="currentColor" d="M15.504 13.616l-3.79-3.223c-0.392-0.353-0.811-0.514-1.149-0.499 0.895-1.048 1.435-2.407 1.435-3.893 0-3.314-2.686-6-6-6s-6 2.686-6 6 2.686 6 6 6c1.486 0 2.845-0.54 3.893-1.435-0.016 0.338 0.146 0.757 0.499 1.149l3.223 3.79c0.552 0.613 1.453 0.665 2.003 0.115s0.498-1.452-0.115-2.003zM6 10c-2.209 0-4-1.791-4-4s1.791-4 4-4 4 1.791 4 4-1.791 4-4 4z"/>
            </svg>
            <span class="sg-visually-hidden">Search</span>
          </button>
        </form>
      </div>
    </div>
  </header>
  <!-- Site Navigation Header (white) -->
  <nav class="site-nav" role="navigation" aria-label="Main navigation">
    <div class="site-nav__wrapper">
      <ul class="site-nav__list" id="nav-menu">
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/" class="site-nav__link">Home</a>
          </li>
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/getting-started/" class="site-nav__link">Getting Started</a>
          </li>
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/architecture/" class="site-nav__link">Architecture</a>
          </li>
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/scotaccount-complete-guide/" class="site-nav__link site-nav__link--active">Complete Guide</a>
          </li>
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/scotaccount-token-validation-module/" class="site-nav__link">Token Validation</a>
          </li>
        
      </ul>
    </div>
  </nav>

  <!-- Main layout container -->
  <div class="container">
    <!-- Sidebar with page-specific navigation -->
    
    <aside class="sidebar" role="complementary" aria-label="Page navigation">
      <h2 class="sidebar__title">On this page</h2>
      <nav class="sidebar__nav" aria-label="Page contents">
        <ul class="sidebar__nav">
          <!-- Table of contents will be injected here via JavaScript -->
          <li class="sidebar__nav-item">
            <a href="#" class="sidebar__nav-link" id="toc-placeholder">
              Contents loading...
            </a>
          </li>
        </ul>
      </nav>
      
      
      <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--sg-border-grey);">
      <h3 class="sidebar__title">All pages</h3>
      <ul class="sidebar__nav">
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/architecture/" 
              class="sidebar__nav-link">
              ScotAccount Architecture Overview
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/getting-started/" 
              class="sidebar__nav-link">
              Getting Started with ScotAccount
            </a>
          </li>
          
        
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/integration-examples/" 
              class="sidebar__nav-link">
              Integration Examples and Best Practices
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/scotaccount-complete-guide/" 
              class="sidebar__nav-link">
              Complete Implementation Guide
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/scotaccount-modular-structure/" 
              class="sidebar__nav-link">
              ScotAccount Modular Structure
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/scotaccount-token-validation-module/" 
              class="sidebar__nav-link">
              Token Validation Module
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/search/" 
              class="sidebar__nav-link">
              Search results
            </a>
          </li>
          
        
      </ul>
      
    </aside>
    

    <!-- Main content -->
    <main class="main" id="main-content" role="main" tabindex="-1">
      
        <h1>Complete Implementation Guide</h1>
      
      
      
        <p class="lead">Comprehensive technical guide for implementing ScotAccount authentication and verified attributes</p>
      

      <!-- Page content -->
      <p>This comprehensive guide provides detailed technical implementation instructions for integrating with ScotAccount. Follow these steps to build secure authentication with optional verified attributes.</p>
<p><div class="table-of-contents"><ul><li><a href="#understanding-scotaccount">Understanding ScotAccount</a></li><li><a href="#why-openid-connect-and-oauth-2-0">Why OpenID Connect and OAuth 2.0</a></li><li><a href="#architecture-overview">Architecture Overview</a></li><li><a href="#implementation-overview">Implementation Overview</a><ul><li><a href="#expected-timeline">Expected Timeline</a></li></ul></li><li><a href="#phase-1-setup-and-registration">Phase 1: Setup &amp; Registration</a><ul><li><a href="#generate-cryptographic-keys">Generate Cryptographic Keys</a></li><li><a href="#secure-key-storage">Secure Key Storage</a></li><li><a href="#service-registration">Service Registration</a></li><li><a href="#registration-response">Registration Response</a></li></ul></li><li><a href="#phase-2-basic-authentication">Phase 2: Basic Authentication</a><ul><li><a href="#discovery-endpoint-integration">Discovery Endpoint Integration</a></li><li><a href="#pkce-implementation">PKCE Implementation</a></li><li><a href="#authorisation-request">Authorisation Request</a></li><li><a href="#callback-handling">Callback Handling</a></li><li><a href="#client-assertion">Client Assertion</a></li><li><a href="#token-exchange">Token Exchange</a></li><li><a href="#id-token-validation">ID Token Validation</a></li></ul></li><li><a href="#phase-3-verified-attributes">Phase 3: Verified Attributes</a><ul><li><a href="#verified-attributes-and-consent">Verified Attributes and Consent</a></li></ul></li><li><a href="#phase-4-production-deployment">Phase 4: Production Deployment</a><ul><li><a href="#environments-and-configuration">Environments and Configuration</a></li><li><a href="#monitoring-and-logging">Monitoring and Logging</a></li><li><a href="#error-handling">Error Handling</a></li><li><a href="#security-checklist">Security Checklist</a></li></ul></li><li><a href="#implementation-references">Implementation References</a></li><li><a href="#troubleshooting-common-issues">Troubleshooting Common Issues</a><ul><li><a href="#invalid-client-assertion">Invalid Client Assertion</a></li><li><a href="#state-parameter-mismatch">State Parameter Mismatch</a></li><li><a href="#token-validation-failures">Token Validation Failures</a></li><li><a href="#pkce-errors">PKCE Errors</a></li></ul></li><li><a href="#support-and-next-steps">Support and Next Steps</a></li></ul></div></p>
<h2 id="understanding-scotaccount" tabindex="-1"><a class="header-anchor" href="#understanding-scotaccount"><span>Understanding ScotAccount</span></a></h2>
<p>ScotAccount is Scotland’s centralised digital identity provider that lets government services authenticate users securely and, with consent, access verified personal information. Rather than building and operating your own authentication and identity verification stack, you rely on ScotAccount to provide:</p>
<ul>
<li>Consistent user authentication with a persistent UUID per user</li>
<li>Access to verified attributes when required, with clear user consent</li>
<li>Standards-based security built on OpenID Connect and OAuth 2.0</li>
</ul>
<p>From a service perspective, this reduces security and compliance overheads, and gives users a single, familiar journey across services.</p>
<h2 id="why-openid-connect-and-oauth-2-0" tabindex="-1"><a class="header-anchor" href="#why-openid-connect-and-oauth-2-0"><span>Why OpenID Connect and OAuth 2.0</span></a></h2>
<p>OpenID Connect adds an identity layer to OAuth 2.0. Together they provide a robust, standards-based approach with built-in controls:</p>
<ul>
<li>State for CSRF protection</li>
<li>Nonce for replay protection</li>
<li>PKCE to protect the authorisation code flow</li>
</ul>
<p>Your service redirects the user to ScotAccount for authentication and receives cryptographically signed tokens that you validate using ScotAccount’s public keys.</p>
<h2 id="architecture-overview" tabindex="-1"><a class="header-anchor" href="#architecture-overview"><span>Architecture Overview</span></a></h2>
<p>At a high level, the user is redirected from your service to ScotAccount to authenticate. Your backend exchanges the returned authorisation code for tokens, validates the ID token, and creates a session. If verified attributes are required, you initiate a new flow requesting additional scopes and call the attributes endpoint with the access token and a client assertion to receive a signed claims token.</p>
<p>For a detailed diagram and component overview, see the Architecture page.</p>
<h2 id="implementation-overview" tabindex="-1"><a class="header-anchor" href="#implementation-overview"><span>Implementation Overview</span></a></h2>
<p>ScotAccount integration follows a four-phase approach:</p>
<ol>
<li><strong>Setup &amp; Registration</strong> - Generate keys and register your service</li>
<li><strong>Basic Authentication</strong> - Implement OpenID Connect authentication flow</li>
<li><strong>Verified Attributes</strong> - Add identity, address, and email verification</li>
<li><strong>Production Deployment</strong> - Go live with monitoring and security measures</li>
</ol>
<h3 id="expected-timeline" tabindex="-1"><a class="header-anchor" href="#expected-timeline"><span>Expected Timeline</span></a></h3>
<ul>
<li><strong>Phase 1</strong>: 1-2 days (setup and registration)</li>
<li><strong>Phase 2</strong>: 3-5 days (basic authentication implementation)</li>
<li><strong>Phase 3</strong>: 2-3 days (verified attributes, if required)</li>
<li><strong>Phase 4</strong>: 2-3 days (production deployment and testing)</li>
</ul>
<p><strong>Total</strong>: 2-4 weeks from start to production</p>
<h2 id="phase-1-setup-and-registration" tabindex="-1"><a class="header-anchor" href="#phase-1-setup-and-registration"><span>Phase 1: Setup &amp; Registration</span></a></h2>
<h3 id="generate-cryptographic-keys" tabindex="-1"><a class="header-anchor" href="#generate-cryptographic-keys"><span>Generate Cryptographic Keys</span></a></h3>
<p><strong>RSA Key Pair (Recommended)</strong>:</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Generate private key</span>
openssl genpkey <span class="token parameter variable">-algorithm</span> RSA <span class="token parameter variable">-out</span> private_key.pem <span class="token parameter variable">-keylen</span> <span class="token number">3072</span>

<span class="token comment"># Extract public key</span>
openssl rsa <span class="token parameter variable">-in</span> private_key.pem <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> public_key.pem

<span class="token comment"># Verify key length</span>
openssl rsa <span class="token parameter variable">-in</span> private_key.pem <span class="token parameter variable">-text</span> <span class="token parameter variable">-noout</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Private-Key"</span></code></pre>
<p><strong>EC Key Pair (Alternative)</strong>:</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Generate EC private key</span>
openssl ecparam <span class="token parameter variable">-genkey</span> <span class="token parameter variable">-name</span> prime256v1 <span class="token parameter variable">-out</span> ec_private_key.pem

<span class="token comment"># Extract public key</span>
openssl ec <span class="token parameter variable">-in</span> ec_private_key.pem <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> ec_public_key.pem</code></pre>
<h3 id="secure-key-storage" tabindex="-1"><a class="header-anchor" href="#secure-key-storage"><span>Secure Key Storage</span></a></h3>
<p>Store private keys securely using a secrets manager:</p>
<p><strong>AWS Secrets Manager</strong>:</p>
<pre class="language-bash"><code class="language-bash">aws secretsmanager create-secret <span class="token punctuation">\</span>
  <span class="token parameter variable">--name</span> <span class="token string">"scotaccount/private-key"</span> <span class="token punctuation">\</span>
  --secret-string file://private_key.pem</code></pre>
<p><strong>Azure Key Vault</strong>:</p>
<pre class="language-bash"><code class="language-bash">az keyvault secret <span class="token builtin class-name">set</span> <span class="token punctuation">\</span>
  --vault-name <span class="token string">"your-keyvault"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--name</span> <span class="token string">"scotaccount-private-key"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--file</span> private_key.pem</code></pre>
<h3 id="service-registration" tabindex="-1"><a class="header-anchor" href="#service-registration"><span>Service Registration</span></a></h3>
<p>Submit these details to the ScotAccount team:</p>
<p><strong>Required Information</strong>:</p>
<ul>
<li><strong>Service name</strong> and description</li>
<li><strong>Public key</strong> (from generated key pair)</li>
<li><strong>Redirect URIs</strong> (where users return after authentication)</li>
<li><strong>Post-logout redirect URIs</strong> (where users go after logout)</li>
<li><strong>Required scopes</strong> (see scope reference below)</li>
<li><strong>Production IP addresses</strong> (if IP allowlisting required)</li>
<li><strong>Technical contact</strong> details</li>
</ul>
<p><strong>Scope Reference</strong>:</p>
<ul>
<li><code>openid</code> - Required for all integrations</li>
<li><code>scotaccount.gpg45.medium</code> - Verified identity (GPG45 Medium)</li>
<li><code>scotaccount.address</code> - Verified postal address</li>
<li><code>scotaccount.email</code> - Verified email address</li>
</ul>
<h3 id="registration-response" tabindex="-1"><a class="header-anchor" href="#registration-response"><span>Registration Response</span></a></h3>
<p>You’ll receive:</p>
<ul>
<li><strong>Client ID</strong> - Your unique service identifier</li>
<li><strong>Configuration URLs</strong> - Integration and production endpoints</li>
<li><strong>Testing credentials</strong> - For development environment access</li>
</ul>
<h2 id="phase-2-basic-authentication" tabindex="-1"><a class="header-anchor" href="#phase-2-basic-authentication"><span>Phase 2: Basic Authentication</span></a></h2>
<h3 id="discovery-endpoint-integration" tabindex="-1"><a class="header-anchor" href="#discovery-endpoint-integration"><span>Discovery Endpoint Integration</span></a></h3>
<p>Always retrieve current configuration dynamically:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getOidcConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>
    <span class="token string">"https://authz.integration.scotaccount.service.gov.scot/.well-known/openid-configuration"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>Key configuration values</strong>:</p>
<ul>
<li><code>authorization_endpoint</code> - Where to send authentication requests</li>
<li><code>token_endpoint</code> - Where to exchange codes for tokens</li>
<li><code>jwks_uri</code> - Public keys for token validation</li>
</ul>
<h3 id="pkce-implementation" tabindex="-1"><a class="header-anchor" href="#pkce-implementation"><span>PKCE Implementation</span></a></h3>
<p>You must generate a code verifier and corresponding SHA256-based code challenge, and include the challenge in the initial authorisation request. When exchanging the code for tokens, provide the original verifier. This binds the returned authorisation code to your original request and prevents interception.</p>
<h3 id="authorisation-request" tabindex="-1"><a class="header-anchor" href="#authorisation-request"><span>Authorisation Request</span></a></h3>
<p>Build an authorisation URL including: <code>client_id</code>, <code>redirect_uri</code>, <code>response_type=code</code>, <code>scope</code>, <code>state</code>, <code>nonce</code>, <code>code_challenge</code>, and <code>code_challenge_method=S256</code>. Store the <code>state</code>, <code>nonce</code>, and PKCE verifier securely until the callback is processed.</p>
<h3 id="callback-handling" tabindex="-1"><a class="header-anchor" href="#callback-handling"><span>Callback Handling</span></a></h3>
<p>Validate the returned <code>state</code> before doing anything else. If it does not match, reject the response. Extract the authorisation <code>code</code>, retrieve the stored <code>nonce</code> and PKCE verifier, and proceed to token exchange.</p>
<h3 id="client-assertion" tabindex="-1"><a class="header-anchor" href="#client-assertion"><span>Client Assertion</span></a></h3>
<p>Authenticate your client to the token and attributes endpoints using a signed JWT (private_key_jwt). The assertion includes <code>iss</code>, <code>sub</code>, <code>aud</code> (endpoint URL), <code>exp</code> (up to 6 months), <code>iat</code>, and a unique <code>jti</code>.</p>
<h3 id="token-exchange" tabindex="-1"><a class="header-anchor" href="#token-exchange"><span>Token Exchange</span></a></h3>
<p>Exchange the authorisation code at the token endpoint with: <code>grant_type=authorization_code</code>, the received <code>code</code>, your <code>redirect_uri</code>, <code>client_assertion_type</code>, your <code>client_assertion</code>, and the PKCE <code>code_verifier</code>.</p>
<h3 id="id-token-validation" tabindex="-1"><a class="header-anchor" href="#id-token-validation"><span>ID Token Validation</span></a></h3>
<p>Validate the ID token signature using ScotAccount’s JWKS. Check audience equals your client ID, issuer matches discovery, and the <code>nonce</code> matches the original value. Extract <code>sub</code> (persistent user UUID) and <code>sid</code> (session ID).</p>
<h2 id="phase-3-verified-attributes" tabindex="-1"><a class="header-anchor" href="#phase-3-verified-attributes"><span>Phase 3: Verified Attributes</span></a></h2>
<h3 id="verified-attributes-and-consent" tabindex="-1"><a class="header-anchor" href="#verified-attributes-and-consent"><span>Verified Attributes and Consent</span></a></h3>
<p>Request additional scopes only when functionality requires them. Users must be present and consent to sharing each type of verified information. To access verified attributes, start a new authorisation flow with the additional scopes:</p>
<pre class="language-http"><code class="language-http">GET https://authz.integration.scotaccount.service.gov.scot/authorize?
    client_id=your-client-id&amp;
    redirect_uri=https://yourservice.gov.scot/auth/callback&amp;
    response_type=code&amp;
    scope=openid%20scotaccount.email%20scotaccount.address%20scotaccount.gpg45.medium&amp;
    state=your-state&amp;
    nonce=your-nonce&amp;
    code_challenge=your-code-challenge&amp;
    code_challenge_method=S256</code></pre>
<p>After exchanging the code for an access token, request attributes at the attributes endpoint using the access token and a new client assertion whose audience is the attributes URL:</p>
<pre class="language-http"><code class="language-http">GET https://issuer.main.integration.scotaccount.service.gov.scot/attributes/values
<span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Bearer [access-token]</span></span>
<span class="token header"><span class="token header-name keyword">DIS-Client-Assertion</span><span class="token punctuation">:</span> <span class="token header-value">[client-assertion-for-attributes-endpoint]</span></span></code></pre>
<p>The response contains a signed <code>claimsToken</code> JWT. Validate it and read <code>verified_claims</code>. Each entry includes the scope, the verified claims (for example identity names and date of birth), and detailed verification metadata (outcome, trust framework, assurance policy, confidence level, time, and verifier).</p>
<h2 id="phase-4-production-deployment" tabindex="-1"><a class="header-anchor" href="#phase-4-production-deployment"><span>Phase 4: Production Deployment</span></a></h2>
<h3 id="environments-and-configuration" tabindex="-1"><a class="header-anchor" href="#environments-and-configuration"><span>Environments and Configuration</span></a></h3>
<p>Use integration endpoints during development and testing, then switch to production endpoints when onboarding completes. Always resolve actual endpoints via discovery.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">integration</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">discoveryUrl</span><span class="token operator">:</span>
      <span class="token string">"https://authz.integration.scotaccount.service.gov.scot/.well-known/openid-configuration"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">production</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">discoveryUrl</span><span class="token operator">:</span>
      <span class="token string">"https://authz.scotaccount.service.gov.scot/.well-known/openid-configuration"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h3 id="monitoring-and-logging" tabindex="-1"><a class="header-anchor" href="#monitoring-and-logging"><span>Monitoring and Logging</span></a></h3>
<p>Implement comprehensive monitoring for authentication success/failure rates, discovery and JWKS availability, and unusual error patterns. Log events with sufficient detail for troubleshooting whilst protecting sensitive data:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Log authentication events</span>
<span class="token keyword">function</span> <span class="token function">logAuthEvent</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> details</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">timestamp</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">event</span><span class="token operator">:</span> event<span class="token punctuation">,</span>
      <span class="token literal-property property">userId</span><span class="token operator">:</span> userId<span class="token punctuation">,</span>
      <span class="token literal-property property">sessionId</span><span class="token operator">:</span> details<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span>
      <span class="token literal-property property">userAgent</span><span class="token operator">:</span> details<span class="token punctuation">.</span>userAgent<span class="token punctuation">,</span>
      <span class="token literal-property property">ipAddress</span><span class="token operator">:</span> details<span class="token punctuation">.</span>ipAddress<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Track authentication metrics</span>
<span class="token keyword">function</span> <span class="token function">trackMetrics</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> duration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Send to your monitoring system</span>
  metrics<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">scotaccount.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  metrics<span class="token punctuation">.</span><span class="token function">timing</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">scotaccount.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.duration</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="error-handling" tabindex="-1"><a class="header-anchor" href="#error-handling"><span>Error Handling</span></a></h3>
<p>Implement user-friendly error handling:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">handleAuthError</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Authentication error:"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">"access_denied"</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"/auth/cancelled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">"invalid_request"</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Invalid authentication request"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Authentication service temporarily unavailable"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="security-checklist" tabindex="-1"><a class="header-anchor" href="#security-checklist"><span>Security Checklist</span></a></h3>
<p>Before going live, verify:</p>
<ul>
<li>[ ] <strong>Private keys</strong> stored securely in secrets manager</li>
<li>[ ] <strong>HTTPS only</strong> - no HTTP endpoints in production</li>
<li>[ ] <strong>State validation</strong> implemented for CSRF protection</li>
<li>[ ] <strong>Nonce validation</strong> prevents replay attacks</li>
<li>[ ] <strong>Token expiration</strong> handled correctly</li>
<li>[ ] <strong>Session management</strong> implemented securely</li>
<li>[ ] <strong>Error logging</strong> without exposing sensitive data</li>
<li>[ ] <strong>Rate limiting</strong> on authentication endpoints</li>
<li>[ ] <strong>Monitoring</strong> and alerting configured</li>
</ul>
<h2 id="implementation-references" tabindex="-1"><a class="header-anchor" href="#implementation-references"><span>Implementation References</span></a></h2>
<p>For end-to-end implementation examples and code, see the following developer-focused pages:</p>
<ul>
<li>Integration Examples and Best Practices</li>
<li>Token Validation Module</li>
</ul>
<p>Below is a minimal Node.js/Express example to illustrate request sequencing. For production-ready code, refer to the pages above.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"jsonwebtoken"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"crypto"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Configuration</span>
<span class="token keyword">const</span> <span class="token constant">CLIENT_ID</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SCOTACCOUNT_CLIENT_ID</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PRIVATE_KEY</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SCOTACCOUNT_PRIVATE_KEY</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REDIRECT_URI</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SCOTACCOUNT_REDIRECT_URI</span><span class="token punctuation">;</span>

<span class="token comment">// Routes</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/auth/login"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getOidcConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> pkce <span class="token operator">=</span> <span class="token function">generatePKCE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> authUrl <span class="token operator">=</span> <span class="token function">buildAuthUrl</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> pkce<span class="token punctuation">,</span> <span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span> <span class="token constant">REDIRECT_URI</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>authUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleAuthError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/auth/callback"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> callbackData <span class="token operator">=</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getOidcConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> clientAssertion <span class="token operator">=</span> <span class="token function">createClientAssertion</span><span class="token punctuation">(</span>
      <span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span>
      config<span class="token punctuation">.</span>token_endpoint<span class="token punctuation">,</span>
      <span class="token constant">PRIVATE_KEY</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exchangeCodeForTokens</span><span class="token punctuation">(</span>
      config<span class="token punctuation">,</span>
      callbackData<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
      <span class="token constant">REDIRECT_URI</span><span class="token punctuation">,</span>
      callbackData<span class="token punctuation">.</span>codeVerifier<span class="token punctuation">,</span>
      clientAssertion
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">validateIdToken</span><span class="token punctuation">(</span>
      tokens<span class="token punctuation">.</span>id_token<span class="token punctuation">,</span>
      <span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span>
      config<span class="token punctuation">,</span>
      callbackData<span class="token punctuation">.</span>nonce
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store user session</span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user <span class="token operator">=</span> userInfo<span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"/dashboard"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleAuthError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Server running on port 3000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="troubleshooting-common-issues" tabindex="-1"><a class="header-anchor" href="#troubleshooting-common-issues"><span>Troubleshooting Common Issues</span></a></h2>
<h3 id="invalid-client-assertion" tabindex="-1"><a class="header-anchor" href="#invalid-client-assertion"><span>Invalid Client Assertion</span></a></h3>
<p><strong>Symptom</strong>: <code>invalid_client</code> error during token exchange<br>
<strong>Solution</strong>: Check JWT claims, expiration time, and private key format</p>
<h3 id="state-parameter-mismatch" tabindex="-1"><a class="header-anchor" href="#state-parameter-mismatch"><span>State Parameter Mismatch</span></a></h3>
<p><strong>Symptom</strong>: CSRF protection errors<br>
<strong>Solution</strong>: Ensure state is generated, stored, and validated correctly</p>
<h3 id="token-validation-failures" tabindex="-1"><a class="header-anchor" href="#token-validation-failures"><span>Token Validation Failures</span></a></h3>
<p><strong>Symptom</strong>: JWT verification errors<br>
<strong>Solution</strong>: Verify audience, issuer, and nonce claims match expected values</p>
<h3 id="pkce-errors" tabindex="-1"><a class="header-anchor" href="#pkce-errors"><span>PKCE Errors</span></a></h3>
<p><strong>Symptom</strong>: <code>invalid_grant</code> errors<br>
<strong>Solution</strong>: Ensure code verifier and challenge are generated and used correctly</p>
<h2 id="support-and-next-steps" tabindex="-1"><a class="header-anchor" href="#support-and-next-steps"><span>Support and Next Steps</span></a></h2>
<div class="callout callout--success">
<strong>Implementation complete?</strong> Review the <a href="/sg-identity-techdocs/scotaccount-token-validation-module/">Token Validation Module</a> for advanced security patterns.
</div>
<div class="callout callout--info">
<strong>Need architecture details?</strong> See the <a href="/sg-identity-techdocs/architecture/">Architecture Overview</a> for system components and data flows.
</div>
<div class="callout callout--warning">
<strong>Ready for production?</strong> Contact the ScotAccount team for production onboarding and security review.
</div>


      <!-- Last updated -->
      
      <footer class="content-footer">
        <p><small>Last updated: 14 August 2025</small></p>
      </footer>
      
    </main>
  </div>

  <!-- Site footer (Scottish Government Style) -->
  <footer class="sg-footer" role="contentinfo">
    <div class="sg-footer__container">
      <div class="sg-footer__content">
        <div class="sg-footer__section">
          <h3 class="sg-footer__heading">ScotAccount</h3>
            <ul class="sg-footer__links">
            <li><a href="/sg-identity-techdocs/" class="sg-footer__link">Documentation home</a></li>
            <li><a href="/sg-identity-techdocs/getting-started/" class="sg-footer__link">Getting started</a></li>
            <li><a href="/sg-identity-techdocs/scotaccount-complete-guide/" class="sg-footer__link">Complete guide</a></li>
            </ul>
        </div>
        
        <div class="sg-footer__section">
          <h3 class="sg-footer__heading">Scottish Government</h3>
          <ul class="sg-footer__links">
            <li><a href="https://www.gov.scot" target="_blank" rel="noopener" class="sg-footer__link">gov.scot</a></li>
            <li><a href="https://www.gov.scot/about/how-government-is-run/directorates/digital-directorate/" target="_blank" rel="noopener" class="sg-footer__link">Digital Directorate</a></li>
            <li><a href="https://www.gov.scot/publications/" target="_blank" rel="noopener" class="sg-footer__link">Publications</a></li>
          </ul>
        </div>
        
        <div class="sg-footer__section">
          <h3 class="sg-footer__heading">Help and support</h3>
          <ul class="sg-footer__links">
            <li><a href="https://www.gov.scot/about/contact-information/" target="_blank" rel="noopener" class="sg-footer__link">Contact us</a></li>
            <li><a href="https://www.gov.scot/accessibility/" target="_blank" rel="noopener" class="sg-footer__link">Accessibility</a></li>
            <li><a href="https://www.gov.scot/privacy/" target="_blank" rel="noopener" class="sg-footer__link">Privacy</a></li>
            <li><a href="https://www.gov.scot/cookies/" target="_blank" rel="noopener" class="sg-footer__link">Cookies</a></li>
          </ul>
        </div>
      </div>
      
      <div class="sg-footer__legal">
        <p class="sg-footer__copyright">&copy; Crown Copyright. All content is available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank" rel="noopener" class="sg-footer__link">Open Government Licence v3.0</a>, except where otherwise stated.</p>
        <p class="sg-footer__site">
          <a href="https://gov.scot" class="sg-footer__link">gov.scot</a>
        </p>
      </div>
    </div>
  </footer>

  <!-- JavaScript for table of contents generation -->
  <script>
    // Generate table of contents for better scannable structure
    document.addEventListener('DOMContentLoaded', function() {
      const headings = document.querySelectorAll('main h2, main h3, main h4');
      const tocContainer = document.querySelector('.sidebar__nav');
      const placeholder = document.getElementById('toc-placeholder');
      
      if (headings.length > 0 && tocContainer && placeholder) {
        // Remove placeholder
        placeholder.remove();
        
        // Generate TOC
        headings.forEach(function(heading, index) {
          // Add ID to heading if it doesn't have one
          if (!heading.id) {
            heading.id = 'heading-' + index;
          }
          
          // Create TOC item
          const li = document.createElement('li');
          li.className = 'sidebar__nav-item';
          
          const a = document.createElement('a');
          a.href = '#' + heading.id;
          a.className = 'sidebar__nav-link';
          a.textContent = heading.textContent;
          
          // Add visual hierarchy for different heading levels
          if (heading.tagName === 'H3') {
            a.style.paddingLeft = '2rem';
          } else if (heading.tagName === 'H4') {
            a.style.paddingLeft = '3rem';
          }
          
          li.appendChild(a);
          tocContainer.appendChild(li);
        });
      } else if (placeholder) {
        placeholder.textContent = 'No headings found';
      }
      
      // Smooth scroll for anchor links
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            target.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        });
      });
    });

    // Cookie banner functionality (Scottish Government style)
    function acceptAllCookies() {
      localStorage.setItem('cookiePreference', 'all');
      hideCookieBanner();
    }

    function useEssentialCookies() {
      localStorage.setItem('cookiePreference', 'essential');
      hideCookieBanner();
    }

    function setCookiePreferences() {
      // In a real implementation, this would open a preferences modal
      localStorage.setItem('cookiePreference', 'essential');
      hideCookieBanner();
      alert('Cookie preferences saved. Only essential cookies will be used.');
    }

    function hideCookieBanner() {
      const banner = document.getElementById('cookie-banner');
      if (banner) {
        banner.style.display = 'none';
      }
    }

    // Check if user has already made a cookie preference
    document.addEventListener('DOMContentLoaded', function() {
      const cookiePreference = localStorage.getItem('cookiePreference');
      if (cookiePreference) {
        hideCookieBanner();
      }
    });

    // Mobile navigation toggle
    document.addEventListener('DOMContentLoaded', function() {
      const navToggle = document.querySelector('.sg-nav__toggle');
      const navMenu = document.querySelector('.sg-nav__list');
      
      if (navToggle && navMenu) {
        navToggle.addEventListener('click', function() {
          const isExpanded = navToggle.getAttribute('aria-expanded') === 'true';
          navToggle.setAttribute('aria-expanded', !isExpanded);
          navMenu.classList.toggle('sg-nav__list--open');
        });
      }
    });
  </script>

  <!-- Search functionality -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
  <script src="/sg-identity-techdocs/js/search.js"></script>
</body>
</html>
