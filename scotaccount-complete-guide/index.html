<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Implementation Guide | ScotAccount Technical Documentation</title>
  <meta name="description" content="Comprehensive technical guide for implementing ScotAccount authentication and verified attributes">
  <link rel="canonical" href="https://scotaccount.github.io/sg-identity-techdocs/scotaccount-complete-guide/">
  
  <!-- Scottish Government favicons -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#0065bd">
  
  <!-- Styles -->
  <link rel="stylesheet" href="css/main.css">
  
  <!-- Open Graph -->
  <meta property="og:title" content="Complete Implementation Guide">
  <meta property="og:description" content="Comprehensive technical guide for implementing ScotAccount authentication and verified attributes">
  <meta property="og:type" content="website">
  <meta property="og:url" content="/scotaccount-complete-guide/">
  <meta property="og:image" content="apple-touch-icon.png">
  
  <!-- Schema.org -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "TechArticle",
    "headline": "Complete Implementation Guide",
    "description": "Comprehensive technical guide for implementing ScotAccount authentication and verified attributes",
    "author": {
      "@type": "Organization",
      "name": "Scottish Government",
      "url": "https://www.gov.scot"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Scottish Government",
      "url": "https://www.gov.scot"
    }
  }
  </script>
</head>
<body>
  <!-- Cookie Banner (Scottish Government Style) -->
  <div class="cookie-banner" id="cookie-banner" role="region" aria-labelledby="cookie-banner-heading">
    <div class="cookie-banner__container">
      <div class="cookie-banner__content">
        <h2 id="cookie-banner-heading" class="cookie-banner__heading">Information</h2>
        <p class="cookie-banner__text">We use <a href="#cookies" class="cookie-banner__link">cookies</a> to collect anonymous data to help us improve your site browsing experience.</p>
        <p class="cookie-banner__text">Click 'Accept all cookies' to agree to all cookies that collect anonymous data. To only allow the cookies that make the site work, click 'Use essential cookies only.' Visit 'Set cookie preferences' to control specific cookies.</p>
      </div>
      <div class="cookie-banner__actions">
        <button type="button" class="cookie-banner__button cookie-banner__button--primary" onclick="acceptAllCookies()">Accept all cookies</button>
        <button type="button" class="cookie-banner__button cookie-banner__button--secondary" onclick="useEssentialCookies()">Use essential cookies only</button>
        <button type="button" class="cookie-banner__button cookie-banner__button--link" onclick="setCookiePreferences()">Set cookie preferences</button>
      </div>
    </div>
  </div>

  <!-- Skip to main content for accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Scottish Government Identity Header (blue) -->
  <header class="sg-header" role="banner">
    <div class="sg-header__wrapper">
      <div class="sg-header__branding">
        <a href="/sg-identity-techdocs/" class="sg-header__logo">
          <img src="assets/scotgovlogo.svg" alt="Scottish Government">
        </a>
      </div>
      <div class="sg-header__search">
        <form class="sg-header__search-form" role="search" action="search" method="get">
          <label for="search-input" class="sg-header__search-label">Search</label>
          <input type="search" id="search-input" name="q" class="sg-header__search-input" placeholder="Search">
          <button type="submit" class="sg-header__search-button">
            <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
              <path fill="currentColor" d="M15.504 13.616l-3.79-3.223c-0.392-0.353-0.811-0.514-1.149-0.499 0.895-1.048 1.435-2.407 1.435-3.893 0-3.314-2.686-6-6-6s-6 2.686-6 6 2.686 6 6 6c1.486 0 2.845-0.54 3.893-1.435-0.016 0.338 0.146 0.757 0.499 1.149l3.223 3.79c0.552 0.613 1.453 0.665 2.003 0.115s0.498-1.452-0.115-2.003zM6 10c-2.209 0-4-1.791-4-4s1.791-4 4-4 4 1.791 4 4-1.791 4-4 4z"></path>
            </svg>
            <span class="sg-visually-hidden">Search</span>
          </button>
        </form>
      </div>
    </div>
  </header>
  <!-- Site Navigation Header (white) -->
  <nav class="site-nav" role="navigation" aria-label="Main navigation">
    <div class="site-nav__wrapper">
      <ul class="site-nav__list" id="nav-menu">
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/" class="site-nav__link">Home</a>
          </li>
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/sg-identity-techdocs/getting-started/" class="site-nav__link">Getting Started</a>
          </li>
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/sg-identity-techdocs/architecture/" class="site-nav__link">Architecture</a>
          </li>
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/sg-identity-techdocs/scotaccount-complete-guide/" class="site-nav__link site-nav__link--active">Complete Guide</a>
          </li>
        
          <li class="site-nav__item">
            <a href="/sg-identity-techdocs/sg-identity-techdocs/scotaccount-token-validation-module/" class="site-nav__link">Token Validation</a>
          </li>
        
      </ul>
    </div>
  </nav>

  <!-- Main layout container -->
  <div class="container">
    <!-- Sidebar with page-specific navigation -->
    
    <aside class="sidebar" role="complementary" aria-label="Page navigation">
      <h2 class="sidebar__title">On this page</h2>
      <nav class="sidebar__nav" aria-label="Page contents">
        <ul class="sidebar__nav">
          <!-- Table of contents will be injected here via JavaScript -->
          <li class="sidebar__nav-item">
            <a href="#" class="sidebar__nav-link" id="toc-placeholder">
              Contents loading...
            </a>
          </li>
        </ul>
      </nav>
      
      
      <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--sg-border-grey);">
      <h3 class="sidebar__title">All pages</h3>
      <ul class="sidebar__nav">
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/sg-identity-techdocs/architecture/" class="sidebar__nav-link">
              ScotAccount Architecture Overview
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/sg-identity-techdocs/getting-started/" class="sidebar__nav-link">
              Getting Started with ScotAccount
            </a>
          </li>
          
        
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/sg-identity-techdocs/integration-examples/" class="sidebar__nav-link">
              Integration Examples and Best Practices
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/sg-identity-techdocs/scotaccount-complete-guide/" class="sidebar__nav-link">
              Complete Implementation Guide
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/sg-identity-techdocs/scotaccount-modular-structure/" class="sidebar__nav-link">
              ScotAccount Modular Structure
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/sg-identity-techdocs/scotaccount-token-validation-module/" class="sidebar__nav-link">
              Token Validation Module
            </a>
          </li>
          
        
          
          <li class="sidebar__nav-item">
            <a href="/sg-identity-techdocs/sg-identity-techdocs/search/" class="sidebar__nav-link">
              Search results
            </a>
          </li>
          
        
      </ul>
      
    </aside>
    

    <!-- Main content -->
    <main class="main" id="main-content" role="main" tabindex="-1">
      
        <h1>Complete Implementation Guide</h1>
      
      
      
        <p class="lead">Comprehensive technical guide for implementing ScotAccount authentication and verified attributes</p>
      

      <!-- Page content -->
      <p>This comprehensive guide provides detailed technical implementation instructions for integrating with ScotAccount. Follow these steps to build secure authentication with optional verified attributes.</p>
<p></p><div class="table-of-contents"><ul><li><a href="#implementation-overview">Implementation Overview</a><ul><li><a href="#expected-timeline">Expected Timeline</a></li></ul></li><li><a href="#phase-1-setup-and-registration">Phase 1: Setup &amp; Registration</a><ul><li><a href="#generate-cryptographic-keys">Generate Cryptographic Keys</a></li><li><a href="#secure-key-storage">Secure Key Storage</a></li><li><a href="#service-registration">Service Registration</a></li><li><a href="#registration-response">Registration Response</a></li></ul></li><li><a href="#phase-2-basic-authentication">Phase 2: Basic Authentication</a><ul><li><a href="#discovery-endpoint-integration">Discovery Endpoint Integration</a></li><li><a href="#pkce-implementation">PKCE Implementation</a></li><li><a href="#authorization-request">Authorization Request</a></li><li><a href="#callback-handler">Callback Handler</a></li><li><a href="#jwt-client-assertion">JWT Client Assertion</a></li><li><a href="#token-exchange">Token Exchange</a></li><li><a href="#id-token-validation">ID Token Validation</a></li></ul></li><li><a href="#phase-3-verified-attributes">Phase 3: Verified Attributes</a><ul><li><a href="#requesting-additional-scopes">Requesting Additional Scopes</a></li><li><a href="#attribute-data-structure">Attribute Data Structure</a></li><li><a href="#processing-verified-attributes">Processing Verified Attributes</a></li></ul></li><li><a href="#phase-4-production-deployment">Phase 4: Production Deployment</a><ul><li><a href="#environment-configuration">Environment Configuration</a></li><li><a href="#monitoring-and-logging">Monitoring and Logging</a></li><li><a href="#error-handling">Error Handling</a></li><li><a href="#security-checklist">Security Checklist</a></li></ul></li><li><a href="#complete-example-implementation">Complete Example Implementation</a></li><li><a href="#troubleshooting-common-issues">Troubleshooting Common Issues</a><ul><li><a href="#invalid-client-assertion">Invalid Client Assertion</a></li><li><a href="#state-parameter-mismatch">State Parameter Mismatch</a></li><li><a href="#token-validation-failures">Token Validation Failures</a></li><li><a href="#pkce-errors">PKCE Errors</a></li></ul></li><li><a href="#support-and-next-steps">Support and Next Steps</a></li></ul></div><p></p>
<h2 id="implementation-overview" tabindex="-1"><a class="header-anchor" href="#implementation-overview"><span>Implementation Overview</span></a></h2>
<p>ScotAccount integration follows a four-phase approach:</p>
<ol>
<li><strong>Setup &amp; Registration</strong> - Generate keys and register your service</li>
<li><strong>Basic Authentication</strong> - Implement OpenID Connect authentication flow</li>
<li><strong>Verified Attributes</strong> - Add identity, address, and email verification</li>
<li><strong>Production Deployment</strong> - Go live with monitoring and security measures</li>
</ol>
<h3 id="expected-timeline" tabindex="-1"><a class="header-anchor" href="#expected-timeline"><span>Expected Timeline</span></a></h3>
<ul>
<li><strong>Phase 1</strong>: 1-2 days (setup and registration)</li>
<li><strong>Phase 2</strong>: 3-5 days (basic authentication implementation)</li>
<li><strong>Phase 3</strong>: 2-3 days (verified attributes, if required)</li>
<li><strong>Phase 4</strong>: 2-3 days (production deployment and testing)</li>
</ul>
<p><strong>Total</strong>: 2-4 weeks from start to production</p>
<h2 id="phase-1-setup-and-registration" tabindex="-1"><a class="header-anchor" href="#phase-1-setup-and-registration"><span>Phase 1: Setup &amp; Registration</span></a></h2>
<h3 id="generate-cryptographic-keys" tabindex="-1"><a class="header-anchor" href="#generate-cryptographic-keys"><span>Generate Cryptographic Keys</span></a></h3>
<p><strong>RSA Key Pair (Recommended)</strong>:</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Generate private key</span>
openssl genpkey <span class="token parameter variable">-algorithm</span> RSA <span class="token parameter variable">-out</span> private_key.pem <span class="token parameter variable">-keylen</span> <span class="token number">3072</span>

<span class="token comment"># Extract public key</span>
openssl rsa <span class="token parameter variable">-in</span> private_key.pem <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> public_key.pem

<span class="token comment"># Verify key length</span>
openssl rsa <span class="token parameter variable">-in</span> private_key.pem <span class="token parameter variable">-text</span> <span class="token parameter variable">-noout</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Private-Key"</span></code></pre>
<p><strong>EC Key Pair (Alternative)</strong>:</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># Generate EC private key</span>
openssl ecparam <span class="token parameter variable">-genkey</span> <span class="token parameter variable">-name</span> prime256v1 <span class="token parameter variable">-out</span> ec_private_key.pem

<span class="token comment"># Extract public key</span>
openssl ec <span class="token parameter variable">-in</span> ec_private_key.pem <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> ec_public_key.pem</code></pre>
<h3 id="secure-key-storage" tabindex="-1"><a class="header-anchor" href="#secure-key-storage"><span>Secure Key Storage</span></a></h3>
<p>Store private keys securely using a secrets manager:</p>
<p><strong>AWS Secrets Manager</strong>:</p>
<pre class="language-bash"><code class="language-bash">aws secretsmanager create-secret <span class="token punctuation">\</span>
  <span class="token parameter variable">--name</span> <span class="token string">"scotaccount/private-key"</span> <span class="token punctuation">\</span>
  --secret-string file://private_key.pem</code></pre>
<p><strong>Azure Key Vault</strong>:</p>
<pre class="language-bash"><code class="language-bash">az keyvault secret <span class="token builtin class-name">set</span> <span class="token punctuation">\</span>
  --vault-name <span class="token string">"your-keyvault"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--name</span> <span class="token string">"scotaccount-private-key"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--file</span> private_key.pem</code></pre>
<h3 id="service-registration" tabindex="-1"><a class="header-anchor" href="#service-registration"><span>Service Registration</span></a></h3>
<p>Submit these details to the ScotAccount team:</p>
<p><strong>Required Information</strong>:</p>
<ul>
<li><strong>Service name</strong> and description</li>
<li><strong>Public key</strong> (from generated key pair)</li>
<li><strong>Redirect URIs</strong> (where users return after authentication)</li>
<li><strong>Post-logout redirect URIs</strong> (where users go after logout)</li>
<li><strong>Required scopes</strong> (see scope reference below)</li>
<li><strong>Production IP addresses</strong> (if IP allowlisting required)</li>
<li><strong>Technical contact</strong> details</li>
</ul>
<p><strong>Scope Reference</strong>:</p>
<ul>
<li><code>openid</code> - Required for all integrations</li>
<li><code>scotaccount.email</code> - Verified email address</li>
<li><code>scotaccount.address</code> - Verified postal address</li>
<li><code>scotaccount.identity</code> - Verified identity information</li>
<li><code>scotaccount.mobile</code> - Verified mobile phone number</li>
</ul>
<h3 id="registration-response" tabindex="-1"><a class="header-anchor" href="#registration-response"><span>Registration Response</span></a></h3>
<p>Youâ€™ll receive:</p>
<ul>
<li><strong>Client ID</strong> - Your unique service identifier</li>
<li><strong>Configuration URLs</strong> - Integration and production endpoints</li>
<li><strong>Testing credentials</strong> - For development environment access</li>
</ul>
<h2 id="phase-2-basic-authentication" tabindex="-1"><a class="header-anchor" href="#phase-2-basic-authentication"><span>Phase 2: Basic Authentication</span></a></h2>
<h3 id="discovery-endpoint-integration" tabindex="-1"><a class="header-anchor" href="#discovery-endpoint-integration"><span>Discovery Endpoint Integration</span></a></h3>
<p>Always retrieve current configuration dynamically:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getOidcConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>
    <span class="token string">"https://authz.scotaccount.service.gov.scot/.well-known/openid-configuration"</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>Key configuration values</strong>:</p>
<ul>
<li><code>authorization_endpoint</code> - Where to send authentication requests</li>
<li><code>token_endpoint</code> - Where to exchange codes for tokens</li>
<li><code>jwks_uri</code> - Public keys for token validation</li>
<li><code>end_session_endpoint</code> - Logout endpoint</li>
</ul>
<h3 id="pkce-implementation" tabindex="-1"><a class="header-anchor" href="#pkce-implementation"><span>PKCE Implementation</span></a></h3>
<p>Generate PKCE parameters for security:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">generatePKCE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Generate random code verifier</span>
  <span class="token keyword">const</span> codeVerifier <span class="token operator">=</span> <span class="token function">base64URLEncode</span><span class="token punctuation">(</span>crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Create SHA256 hash</span>
  <span class="token keyword">const</span> hash <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">"sha256"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>codeVerifier<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> codeChallenge <span class="token operator">=</span> <span class="token function">base64URLEncode</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    codeVerifier<span class="token punctuation">,</span>
    codeChallenge<span class="token punctuation">,</span>
    <span class="token literal-property property">codeChallengeMethod</span><span class="token operator">:</span> <span class="token string">"S256"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="authorization-request" tabindex="-1"><a class="header-anchor" href="#authorization-request"><span>Authorization Request</span></a></h3>
<p>Build the authentication URL:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">buildAuthUrl</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token punctuation">,</span> pkce<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> redirectUri</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> nonce <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">client_id</span><span class="token operator">:</span> clientId<span class="token punctuation">,</span>
    <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> redirectUri<span class="token punctuation">,</span>
    <span class="token literal-property property">response_type</span><span class="token operator">:</span> <span class="token string">"code"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">"openid"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> state<span class="token punctuation">,</span>
    <span class="token literal-property property">nonce</span><span class="token operator">:</span> nonce<span class="token punctuation">,</span>
    <span class="token literal-property property">code_challenge</span><span class="token operator">:</span> pkce<span class="token punctuation">.</span>codeChallenge<span class="token punctuation">,</span>
    <span class="token literal-property property">code_challenge_method</span><span class="token operator">:</span> pkce<span class="token punctuation">.</span>codeChallengeMethod<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Store state and nonce for validation</span>
  <span class="token function">storeSecurely</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> nonce<span class="token punctuation">,</span> <span class="token literal-property property">codeVerifier</span><span class="token operator">:</span> pkce<span class="token punctuation">.</span>codeVerifier <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>authorization_endpoint<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="callback-handler" tabindex="-1"><a class="header-anchor" href="#callback-handler"><span>Callback Handler</span></a></h3>
<p>Process the authentication response:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> state<span class="token punctuation">,</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>

  <span class="token comment">// Handle errors first</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Authentication failed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Validate state parameter</span>
  <span class="token keyword">const</span> storedData <span class="token operator">=</span> <span class="token function">retrieveSecurely</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>storedData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Invalid state parameter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">,</span>
    state<span class="token punctuation">,</span>
    <span class="token literal-property property">nonce</span><span class="token operator">:</span> storedData<span class="token punctuation">.</span>nonce<span class="token punctuation">,</span>
    <span class="token literal-property property">codeVerifier</span><span class="token operator">:</span> storedData<span class="token punctuation">.</span>codeVerifier<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="jwt-client-assertion" tabindex="-1"><a class="header-anchor" href="#jwt-client-assertion"><span>JWT Client Assertion</span></a></h3>
<p>Create signed JWT for token exchange:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createClientAssertion</span><span class="token punctuation">(</span><span class="token parameter">clientId<span class="token punctuation">,</span> tokenEndpoint<span class="token punctuation">,</span> privateKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> now <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">iss</span><span class="token operator">:</span> clientId<span class="token punctuation">,</span>
    <span class="token literal-property property">sub</span><span class="token operator">:</span> clientId<span class="token punctuation">,</span>
    <span class="token literal-property property">aud</span><span class="token operator">:</span> tokenEndpoint<span class="token punctuation">,</span>
    <span class="token literal-property property">exp</span><span class="token operator">:</span> now <span class="token operator">+</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// 1 minute expiration</span>
    <span class="token literal-property property">iat</span><span class="token operator">:</span> now<span class="token punctuation">,</span>
    <span class="token literal-property property">jti</span><span class="token operator">:</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> privateKey<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">algorithm</span><span class="token operator">:</span> <span class="token string">"RS256"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="token-exchange" tabindex="-1"><a class="header-anchor" href="#token-exchange"><span>Token Exchange</span></a></h3>
<p>Exchange authorization code for tokens:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">exchangeCodeForTokens</span><span class="token punctuation">(</span>
  <span class="token parameter">config<span class="token punctuation">,</span>
  code<span class="token punctuation">,</span>
  redirectUri<span class="token punctuation">,</span>
  codeVerifier<span class="token punctuation">,</span>
  clientAssertion</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>token_endpoint<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">grant_type</span><span class="token operator">:</span> <span class="token string">"authorization_code"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">code</span><span class="token operator">:</span> code<span class="token punctuation">,</span>
      <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> redirectUri<span class="token punctuation">,</span>
      <span class="token literal-property property">client_assertion_type</span><span class="token operator">:</span>
        <span class="token string">"urn:ietf:params:oauth:client-assertion-type:jwt-bearer"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">client_assertion</span><span class="token operator">:</span> clientAssertion<span class="token punctuation">,</span>
      <span class="token literal-property property">code_verifier</span><span class="token operator">:</span> codeVerifier<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Token exchange failed: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>response<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="id-token-validation" tabindex="-1"><a class="header-anchor" href="#id-token-validation"><span>ID Token Validation</span></a></h3>
<p>Validate and extract user information:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">validateIdToken</span><span class="token punctuation">(</span><span class="token parameter">idToken<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> config<span class="token punctuation">,</span> expectedNonce</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Get public keys</span>
  <span class="token keyword">const</span> jwks <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>jwks_uri<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Verify JWT signature and claims</span>
  <span class="token keyword">const</span> decoded <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>idToken<span class="token punctuation">,</span> <span class="token function">getPublicKey</span><span class="token punctuation">(</span>jwks<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">algorithms</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"RS256"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">audience</span><span class="token operator">:</span> clientId<span class="token punctuation">,</span>
    <span class="token literal-property property">issuer</span><span class="token operator">:</span> config<span class="token punctuation">.</span>issuer<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Validate nonce</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>decoded<span class="token punctuation">.</span>nonce <span class="token operator">!==</span> expectedNonce<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Invalid nonce"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">userId</span><span class="token operator">:</span> decoded<span class="token punctuation">.</span>sub<span class="token punctuation">,</span>
    <span class="token literal-property property">sessionId</span><span class="token operator">:</span> decoded<span class="token punctuation">.</span>sid<span class="token punctuation">,</span>
    <span class="token literal-property property">authenticatedAt</span><span class="token operator">:</span> decoded<span class="token punctuation">.</span>auth_time<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="phase-3-verified-attributes" tabindex="-1"><a class="header-anchor" href="#phase-3-verified-attributes"><span>Phase 3: Verified Attributes</span></a></h2>
<h3 id="requesting-additional-scopes" tabindex="-1"><a class="header-anchor" href="#requesting-additional-scopes"><span>Requesting Additional Scopes</span></a></h3>
<p>To access verified attributes, request additional scopes:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Example: Request email and address verification</span>
<span class="token keyword">const</span> scope <span class="token operator">=</span> <span class="token string">"openid scotaccount.email scotaccount.address"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> authUrl <span class="token operator">=</span> <span class="token function">buildAuthUrl</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> pkce<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> redirectUri<span class="token punctuation">,</span> scope<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="attribute-data-structure" tabindex="-1"><a class="header-anchor" href="#attribute-data-structure"><span>Attribute Data Structure</span></a></h3>
<p><strong>Email Attributes</strong> (<code>scotaccount.email</code> scope):</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scotaccount.email"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"user@example.com"</span><span class="token punctuation">,</span>
    <span class="token property">"verified"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"verified_at"</span><span class="token operator">:</span> <span class="token string">"2024-01-15T10:30:00Z"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>Address Attributes</strong> (<code>scotaccount.address</code> scope):</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scotaccount.address"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"formatted"</span><span class="token operator">:</span> <span class="token string">"123 Main Street\nEdinburgh EH1 1AA\nScotland"</span><span class="token punctuation">,</span>
    <span class="token property">"street_address"</span><span class="token operator">:</span> <span class="token string">"123 Main Street"</span><span class="token punctuation">,</span>
    <span class="token property">"locality"</span><span class="token operator">:</span> <span class="token string">"Edinburgh"</span><span class="token punctuation">,</span>
    <span class="token property">"postal_code"</span><span class="token operator">:</span> <span class="token string">"EH1 1AA"</span><span class="token punctuation">,</span>
    <span class="token property">"country"</span><span class="token operator">:</span> <span class="token string">"Scotland"</span><span class="token punctuation">,</span>
    <span class="token property">"verified"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"verified_at"</span><span class="token operator">:</span> <span class="token string">"2024-01-15T09:15:00Z"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>Identity Attributes</strong> (<code>scotaccount.identity</code> scope):</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scotaccount.identity"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"given_name"</span><span class="token operator">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span>
    <span class="token property">"family_name"</span><span class="token operator">:</span> <span class="token string">"Smith"</span><span class="token punctuation">,</span>
    <span class="token property">"birthdate"</span><span class="token operator">:</span> <span class="token string">"1990-01-15"</span><span class="token punctuation">,</span>
    <span class="token property">"verified"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"verified_at"</span><span class="token operator">:</span> <span class="token string">"2024-01-15T14:20:00Z"</span><span class="token punctuation">,</span>
    <span class="token property">"assurance_level"</span><span class="token operator">:</span> <span class="token string">"GPG45_MEDIUM"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="processing-verified-attributes" tabindex="-1"><a class="header-anchor" href="#processing-verified-attributes"><span>Processing Verified Attributes</span></a></h3>
<p>Extract and validate attribute data:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">processVerifiedAttributes</span><span class="token punctuation">(</span><span class="token parameter">idToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> attributes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Process email verification</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>idToken<span class="token punctuation">[</span><span class="token string">"scotaccount.email"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> email <span class="token operator">=</span> idToken<span class="token punctuation">[</span><span class="token string">"scotaccount.email"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>email<span class="token punctuation">.</span>verified<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      attributes<span class="token punctuation">.</span>verifiedEmail <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">address</span><span class="token operator">:</span> email<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
        <span class="token literal-property property">verifiedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>email<span class="token punctuation">.</span>verified_at<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Process address verification</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>idToken<span class="token punctuation">[</span><span class="token string">"scotaccount.address"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> address <span class="token operator">=</span> idToken<span class="token punctuation">[</span><span class="token string">"scotaccount.address"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>address<span class="token punctuation">.</span>verified<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      attributes<span class="token punctuation">.</span>verifiedAddress <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">formatted</span><span class="token operator">:</span> address<span class="token punctuation">.</span>formatted<span class="token punctuation">,</span>
        <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">street</span><span class="token operator">:</span> address<span class="token punctuation">.</span>street_address<span class="token punctuation">,</span>
          <span class="token literal-property property">city</span><span class="token operator">:</span> address<span class="token punctuation">.</span>locality<span class="token punctuation">,</span>
          <span class="token literal-property property">postcode</span><span class="token operator">:</span> address<span class="token punctuation">.</span>postal_code<span class="token punctuation">,</span>
          <span class="token literal-property property">country</span><span class="token operator">:</span> address<span class="token punctuation">.</span>country<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">verifiedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span>verified_at<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> attributes<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="phase-4-production-deployment" tabindex="-1"><a class="header-anchor" href="#phase-4-production-deployment"><span>Phase 4: Production Deployment</span></a></h2>
<h3 id="environment-configuration" tabindex="-1"><a class="header-anchor" href="#environment-configuration"><span>Environment Configuration</span></a></h3>
<p>Update endpoints for production:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">integration</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">discoveryUrl</span><span class="token operator">:</span>
      <span class="token string">"https://authz.scotaccount.service.gov.scot/.well-known/openid-configuration"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">production</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">discoveryUrl</span><span class="token operator">:</span>
      <span class="token string">"https://authz.scotaccount.service.gov.scot/.well-known/openid-configuration"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h3 id="monitoring-and-logging" tabindex="-1"><a class="header-anchor" href="#monitoring-and-logging"><span>Monitoring and Logging</span></a></h3>
<p>Implement comprehensive monitoring:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Log authentication events</span>
<span class="token keyword">function</span> <span class="token function">logAuthEvent</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> details</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">timestamp</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">event</span><span class="token operator">:</span> event<span class="token punctuation">,</span>
      <span class="token literal-property property">userId</span><span class="token operator">:</span> userId<span class="token punctuation">,</span>
      <span class="token literal-property property">sessionId</span><span class="token operator">:</span> details<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span>
      <span class="token literal-property property">userAgent</span><span class="token operator">:</span> details<span class="token punctuation">.</span>userAgent<span class="token punctuation">,</span>
      <span class="token literal-property property">ipAddress</span><span class="token operator">:</span> details<span class="token punctuation">.</span>ipAddress<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Track authentication metrics</span>
<span class="token keyword">function</span> <span class="token function">trackMetrics</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> duration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Send to your monitoring system</span>
  metrics<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">scotaccount.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  metrics<span class="token punctuation">.</span><span class="token function">timing</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">scotaccount.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.duration</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="error-handling" tabindex="-1"><a class="header-anchor" href="#error-handling"><span>Error Handling</span></a></h3>
<p>Implement user-friendly error handling:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">handleAuthError</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Authentication error:"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">"access_denied"</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"/auth/cancelled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">"invalid_request"</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Invalid authentication request"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Authentication service temporarily unavailable"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="security-checklist" tabindex="-1"><a class="header-anchor" href="#security-checklist"><span>Security Checklist</span></a></h3>
<p>Before going live, verify:</p>
<ul>
<li>[ ] <strong>Private keys</strong> stored securely in secrets manager</li>
<li>[ ] <strong>HTTPS only</strong> - no HTTP endpoints in production</li>
<li>[ ] <strong>State validation</strong> implemented for CSRF protection</li>
<li>[ ] <strong>Nonce validation</strong> prevents replay attacks</li>
<li>[ ] <strong>Token expiration</strong> handled correctly</li>
<li>[ ] <strong>Session management</strong> implemented securely</li>
<li>[ ] <strong>Error logging</strong> without exposing sensitive data</li>
<li>[ ] <strong>Rate limiting</strong> on authentication endpoints</li>
<li>[ ] <strong>Monitoring</strong> and alerting configured</li>
</ul>
<h2 id="complete-example-implementation" tabindex="-1"><a class="header-anchor" href="#complete-example-implementation"><span>Complete Example Implementation</span></a></h2>
<p>Hereâ€™s a complete Node.js/Express example:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"jsonwebtoken"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"crypto"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Configuration</span>
<span class="token keyword">const</span> <span class="token constant">CLIENT_ID</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SCOTACCOUNT_CLIENT_ID</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PRIVATE_KEY</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SCOTACCOUNT_PRIVATE_KEY</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REDIRECT_URI</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SCOTACCOUNT_REDIRECT_URI</span><span class="token punctuation">;</span>

<span class="token comment">// Routes</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/auth/login"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getOidcConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> pkce <span class="token operator">=</span> <span class="token function">generatePKCE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> authUrl <span class="token operator">=</span> <span class="token function">buildAuthUrl</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> pkce<span class="token punctuation">,</span> <span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span> <span class="token constant">REDIRECT_URI</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>authUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleAuthError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/auth/callback"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> callbackData <span class="token operator">=</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getOidcConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> clientAssertion <span class="token operator">=</span> <span class="token function">createClientAssertion</span><span class="token punctuation">(</span>
      <span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span>
      config<span class="token punctuation">.</span>token_endpoint<span class="token punctuation">,</span>
      <span class="token constant">PRIVATE_KEY</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exchangeCodeForTokens</span><span class="token punctuation">(</span>
      config<span class="token punctuation">,</span>
      callbackData<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
      <span class="token constant">REDIRECT_URI</span><span class="token punctuation">,</span>
      callbackData<span class="token punctuation">.</span>codeVerifier<span class="token punctuation">,</span>
      clientAssertion
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">validateIdToken</span><span class="token punctuation">(</span>
      tokens<span class="token punctuation">.</span>id_token<span class="token punctuation">,</span>
      <span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span>
      config<span class="token punctuation">,</span>
      callbackData<span class="token punctuation">.</span>nonce
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Store user session</span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user <span class="token operator">=</span> userInfo<span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"/dashboard"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handleAuthError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Server running on port 3000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="troubleshooting-common-issues" tabindex="-1"><a class="header-anchor" href="#troubleshooting-common-issues"><span>Troubleshooting Common Issues</span></a></h2>
<h3 id="invalid-client-assertion" tabindex="-1"><a class="header-anchor" href="#invalid-client-assertion"><span>Invalid Client Assertion</span></a></h3>
<p><strong>Symptom</strong>: <code>invalid_client</code> error during token exchange<br>
<strong>Solution</strong>: Check JWT claims, expiration time, and private key format</p>
<h3 id="state-parameter-mismatch" tabindex="-1"><a class="header-anchor" href="#state-parameter-mismatch"><span>State Parameter Mismatch</span></a></h3>
<p><strong>Symptom</strong>: CSRF protection errors<br>
<strong>Solution</strong>: Ensure state is generated, stored, and validated correctly</p>
<h3 id="token-validation-failures" tabindex="-1"><a class="header-anchor" href="#token-validation-failures"><span>Token Validation Failures</span></a></h3>
<p><strong>Symptom</strong>: JWT verification errors<br>
<strong>Solution</strong>: Verify audience, issuer, and nonce claims match expected values</p>
<h3 id="pkce-errors" tabindex="-1"><a class="header-anchor" href="#pkce-errors"><span>PKCE Errors</span></a></h3>
<p><strong>Symptom</strong>: <code>invalid_grant</code> errors<br>
<strong>Solution</strong>: Ensure code verifier and challenge are generated and used correctly</p>
<h2 id="support-and-next-steps" tabindex="-1"><a class="header-anchor" href="#support-and-next-steps"><span>Support and Next Steps</span></a></h2>
<div class="callout callout--success">
<strong>Implementation complete?</strong> Review the <a href="/sg-identity-techdocs/scotaccount-token-validation-module/">Token Validation Module</a> for advanced security patterns.
</div>
<div class="callout callout--info">
<strong>Need architecture details?</strong> See the <a href="/sg-identity-techdocs/architecture/">Architecture Overview</a> for system components and data flows.
</div>
<div class="callout callout--warning">
<strong>Ready for production?</strong> Contact the ScotAccount team for production onboarding and security review.
</div>


      <!-- Last updated -->
      
      <footer class="content-footer">
        <p><small>Last updated: 7 August 2025</small></p>
      </footer>
      
    </main>
  </div>

  <!-- Site footer (Scottish Government Style) -->
  <footer class="sg-footer" role="contentinfo">
    <div class="sg-footer__container">
      <div class="sg-footer__content">
        <div class="sg-footer__section">
          <h3 class="sg-footer__heading">ScotAccount</h3>
            <ul class="sg-footer__links">
            <li><a href="/sg-identity-techdocs/" class="sg-footer__link">Documentation home</a></li>
            <li><a href="/sg-identity-techdocs/sg-identity-techdocs/getting-started/" class="sg-footer__link">Getting started</a></li>
            <li><a href="/sg-identity-techdocs/sg-identity-techdocs/scotaccount-complete-guide/" class="sg-footer__link">Complete guide</a></li>
            </ul>
        </div>
        
        <div class="sg-footer__section">
          <h3 class="sg-footer__heading">Scottish Government</h3>
          <ul class="sg-footer__links">
            <li><a href="https://www.gov.scot" target="_blank" rel="noopener" class="sg-footer__link">gov.scot</a></li>
            <li><a href="https://www.gov.scot/about/how-government-is-run/directorates/digital-directorate/" target="_blank" rel="noopener" class="sg-footer__link">Digital Directorate</a></li>
            <li><a href="https://www.gov.scot/publications/" target="_blank" rel="noopener" class="sg-footer__link">Publications</a></li>
          </ul>
        </div>
        
        <div class="sg-footer__section">
          <h3 class="sg-footer__heading">Help and support</h3>
          <ul class="sg-footer__links">
            <li><a href="https://www.gov.scot/about/contact-information/" target="_blank" rel="noopener" class="sg-footer__link">Contact us</a></li>
            <li><a href="https://www.gov.scot/accessibility/" target="_blank" rel="noopener" class="sg-footer__link">Accessibility</a></li>
            <li><a href="https://www.gov.scot/privacy/" target="_blank" rel="noopener" class="sg-footer__link">Privacy</a></li>
            <li><a href="https://www.gov.scot/cookies/" target="_blank" rel="noopener" class="sg-footer__link">Cookies</a></li>
          </ul>
        </div>
      </div>
      
      <div class="sg-footer__legal">
        <p class="sg-footer__copyright">&copy; Crown Copyright. All content is available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank" rel="noopener" class="sg-footer__link">Open Government Licence v3.0</a>, except where otherwise stated.</p>
        <p class="sg-footer__site">
          <a href="https://gov.scot" class="sg-footer__link">gov.scot</a>
        </p>
      </div>
    </div>
  </footer>

  <!-- JavaScript for table of contents generation -->
  <script>
    // Generate table of contents for better scannable structure
    document.addEventListener('DOMContentLoaded', function() {
      const headings = document.querySelectorAll('main h2, main h3, main h4');
      const tocContainer = document.querySelector('.sidebar__nav');
      const placeholder = document.getElementById('toc-placeholder');
      
      if (headings.length > 0 && tocContainer && placeholder) {
        // Remove placeholder
        placeholder.remove();
        
        // Generate TOC
        headings.forEach(function(heading, index) {
          // Add ID to heading if it doesn't have one
          if (!heading.id) {
            heading.id = 'heading-' + index;
          }
          
          // Create TOC item
          const li = document.createElement('li');
          li.className = 'sidebar__nav-item';
          
          const a = document.createElement('a');
          a.href = '#' + heading.id;
          a.className = 'sidebar__nav-link';
          a.textContent = heading.textContent;
          
          // Add visual hierarchy for different heading levels
          if (heading.tagName === 'H3') {
            a.style.paddingLeft = '2rem';
          } else if (heading.tagName === 'H4') {
            a.style.paddingLeft = '3rem';
          }
          
          li.appendChild(a);
          tocContainer.appendChild(li);
        });
      } else if (placeholder) {
        placeholder.textContent = 'No headings found';
      }
      
      // Smooth scroll for anchor links
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            target.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        });
      });
    });

    // Cookie banner functionality (Scottish Government style)
    function acceptAllCookies() {
      localStorage.setItem('cookiePreference', 'all');
      hideCookieBanner();
    }

    function useEssentialCookies() {
      localStorage.setItem('cookiePreference', 'essential');
      hideCookieBanner();
    }

    function setCookiePreferences() {
      // In a real implementation, this would open a preferences modal
      localStorage.setItem('cookiePreference', 'essential');
      hideCookieBanner();
      alert('Cookie preferences saved. Only essential cookies will be used.');
    }

    function hideCookieBanner() {
      const banner = document.getElementById('cookie-banner');
      if (banner) {
        banner.style.display = 'none';
      }
    }

    // Check if user has already made a cookie preference
    document.addEventListener('DOMContentLoaded', function() {
      const cookiePreference = localStorage.getItem('cookiePreference');
      if (cookiePreference) {
        hideCookieBanner();
      }
    });

    // Mobile navigation toggle
    document.addEventListener('DOMContentLoaded', function() {
      const navToggle = document.querySelector('.sg-nav__toggle');
      const navMenu = document.querySelector('.sg-nav__list');
      
      if (navToggle && navMenu) {
        navToggle.addEventListener('click', function() {
          const isExpanded = navToggle.getAttribute('aria-expanded') === 'true';
          navToggle.setAttribute('aria-expanded', !isExpanded);
          navMenu.classList.toggle('sg-nav__list--open');
        });
      }
    });
  </script>

  <!-- Search functionality -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
  <script src="js/search.js"></script>
</body>
</html>
