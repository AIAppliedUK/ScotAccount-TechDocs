@startuml
title ScotAccount Mobile Client OIDC Flow with Endpoint and Risk Annotations

actor User
participant "Mobile App (Public Client)" as App
participant "Authorisation Endpoint (/authorize)" as Authorise
participant "Token Endpoint (/token)" as Token
participant "Attribute Endpoint (/attributes/values)" as Attributes

== Step 1: User Authentication ==
User -> App : [0] Open App / Start Login
App -> Authorise : [1] Authorisation Request (openid, PKCE, redirect_uri)
note right of App
⚠ [1–3] Redirect URI mix-up or open redirect risk
end note

Authorise -> User : [2] Prompt for login and consent
User -> Authorise : Enter credentials and consent
Authorise -> App : [3] Redirect with authorisation code
note right of App
⚠ [3] Code interception risk (e.g. URI scheme hijack)
end note

App -> Token : [4] Token Request (code, code_verifier, client_assertion)
Token -> App : [5] ID Token and Access Token
note right of App
⚠ [5] Secure storage required on device
end note

== Step 2: Request Verified Attributes ==
App -> Authorise : [6] Authorisation Request (openid + attribute scopes)
Authorise -> User : [7] Prompt for consent to share attributes
User -> Authorise : Confirm consent
Authorise -> App : [8] Redirect with new authorisation code

App -> Token : [9] Token Request (new code, code_verifier, client_assertion)
Token -> App : [10] Attribute-scoped Access Token

App -> Attributes : [11] Attribute request (Bearer token)
note right of Attributes
⚠ [11] Risk of token replay without sender-constraining (e.g., DPoP or mTLS)
end note

Attributes -> App : [12] Return verified identity/attributes

@enduml